# 22.3 CharacterAnimationState.Roll + Animator-State

> **Commit:** `feat(phase-22): 22.3 Roll Animation-State und Animator-Integration`
> **Branch:** `feat/roll-animation-state`

---

## Ziel

`CharacterAnimationState.Roll` zum Enum hinzufügen, den Animator Controller um einen Roll-State erweitern und die CrossFade-Konfiguration ergänzen.

## Anweisungen

### 1. CharacterAnimationState Enum erweitern

**Datei:** `Packages/Wiesenwischer.GameKit.CharacterController.Core/Runtime/Core/Animation/IAnimationController.cs`

```csharp
public enum CharacterAnimationState
{
    Locomotion,
    Jump,
    Fall,
    SoftLand,
    HardLand,
    Roll,        // ← NEU
    LightStop,
    MediumStop,
    HardStop,
    Slide
}
```

**Position:** `Roll` nach `HardLand` einfügen — logisch gruppiert bei den Landing-States.

### 2. Animator Controller erweitern

**Datei:** `Packages/Wiesenwischer.GameKit.CharacterController.Animation/Resources/AnimatorControllers/CharacterAnimatorController.controller`

Über den **AnimatorControllerCreator** (Editor-Wizard):
- Neuen State `Roll` im Base Layer hinzufügen
- Animation Clip: `Anim_Roll` (aus 22.1)
- Position im Animator: neben HardLand

**Transitions:**
- **Any State → Roll**: Condition `AnimationState == 5` (Roll Enum-Index)
- **Roll → Locomotion**: Condition `AnimationState == 0` (nach Roll-Ende)
- **Roll → MediumStop**: Condition `AnimationState == 7` (MediumStop)

**Transition Settings:**
- Has Exit Time: **Nein** (für alle Transitions)
- Transition Duration: konfigurierbar über AnimationTransitionConfig

### 3. AnimationTransitionConfig erweitern

**Datei:** `Packages/Wiesenwischer.GameKit.CharacterController.Animation/Runtime/AnimationTransitionConfig.cs`

Neues Feld hinzufügen:

```csharp
[Header("Landing Roll")]
[Tooltip("CrossFade-Dauer für Transition zu Roll")]
[Range(0f, 0.5f)]
[SerializeField] private float _rollTransition = 0.08f;

public float RollTransition => _rollTransition;
```

### 4. AnimatorParameterBridge erweitern

**Datei:** `Packages/Wiesenwischer.GameKit.CharacterController.Animation/Runtime/AnimatorParameterBridge.cs`

In der `PlayState()` Switch-Anweisung den neuen Case hinzufügen:

```csharp
case CharacterAnimationState.Roll:
    transitionDuration = _transitionConfig?.RollTransition ?? 0.08f;
    break;
```

**Hinweis:** Der Animator-State-Name muss exakt `Roll` lauten, damit `Animator.CrossFade("Roll", duration)` funktioniert.

### 5. AnimatorControllerCreator erweitern

**Datei:** `Packages/Wiesenwischer.GameKit.CharacterController.Animation/Editor/AnimatorControllerCreator.cs`

Den Roll-State in die programmatische Controller-Erstellung aufnehmen:
- `"Roll"` zum `requiredStates`-Array hinzufügen (neben `"HardLand"`, `"Slide"` etc.)
- Any State → Roll Transition mit Condition `AnimationState == 5` anlegen

### 6. AnimationWizard erweitern (Editor-UI)

**Datei:** `Packages/Wiesenwischer.GameKit.CharacterController.Animation/Editor/AnimationWizard.cs`

Der AnimationWizard braucht einen neuen FBX-Slot für die Roll-Animation:

**a) Neues Feld:**
```csharp
private GameObject _animRoll;
```

**b) UI-Slot in der "Airborne + Slide" Foldout-Gruppe** (nach `_animHardLand`, vor `_animSlide`):
```csharp
_animRoll = FbxSlot("Roll", _animRoll);
```

**c) Auto-Erkennung** in `AutoDetectAnimationFBXs()`:
```csharp
_animRoll = LoadFbxAsset("Anim_Roll");
```

**d) ConfigureAnim-Aufruf** in `PerformAnimationSetup()` (Airborne-Block, One-Shot, Grounded/Feet):
```csharp
configured += ConfigureAnim(_animRoll, sourceAvatar, false, false, "Roll");
```
**Hinweis:** Roll ist eine Grounded-Animation (Feet-basiert, nicht Airborne/Original), da der Character auf dem Boden rollt.

**e) `requiredStates`-Array** in `AssignClipsToController()`:
```csharp
string[] requiredStates = { "Jump", "Fall", "SoftLand", "HardLand", "Roll",
                            "Slide", "LightStop", "MediumStop", "HardStop" };
```

**f) Clip-Zuweisung** in `AssignClipsToController()`:
```csharp
TryAssignStateMotion(rootSM, "Roll", _animRoll);
```

**g) `HasAnyAnimation()` und `CountAnimSlots()`** erweitern:
```csharp
// In HasAnyAnimation():
... || _animRoll || ...

// In CountAnimSlots():
if (_animRoll) c++;
```

**h) Status-Anzeige:** Zähler von `12` auf `13` ändern:
```csharp
StatusRow("Animation FBXs", count > 0, $"{count}/13 zugewiesen");
```
Ebenso den Auto-Detect Log:
```csharp
Debug.Log($"[AnimationWizard] Auto-Erkennung: {CountAnimSlots()}/13 FBXs gefunden.");
```

## Verifikation

- [ ] `CharacterAnimationState.Roll` existiert im Enum (Index 5, zwischen HardLand und LightStop)
- [ ] Animator Controller hat State `Roll` im Base Layer
- [ ] Transitions: Any State → Roll, Roll → Locomotion, Roll → MediumStop
- [ ] AnimationTransitionConfig hat `RollTransition` Feld (Default: 0.08)
- [ ] AnimatorParameterBridge.PlayState() behandelt `CharacterAnimationState.Roll`
- [ ] AnimatorControllerCreator erstellt Roll-State programmatisch
- [ ] AnimationWizard zeigt "Roll" Slot in "Airborne + Slide" Foldout
- [ ] Auto-Erkennung findet `Anim_Roll.fbx`
- [ ] "Animationen einrichten" konfiguriert und weist Roll-Clip zu
- [ ] Status zeigt `/13` statt `/12`
- [ ] Kompiliert fehlerfrei

## Erwartete Dateien

```
Packages/Wiesenwischer.GameKit.CharacterController.Core/Runtime/Core/Animation/
├── IAnimationController.cs                    ← ERWEITERT (Enum)

Packages/Wiesenwischer.GameKit.CharacterController.Animation/
├── Editor/AnimationWizard.cs                  ← ERWEITERT (Roll-Slot, Auto-Detect, Zuweisung)
├── Editor/AnimatorControllerCreator.cs        ← ERWEITERT (Roll-State)
├── Runtime/AnimationTransitionConfig.cs       ← ERWEITERT
├── Runtime/AnimatorParameterBridge.cs         ← ERWEITERT
├── Resources/AnimatorControllers/
│   └── CharacterAnimatorController.controller ← ERWEITERT
```

---

→ Nächster Schritt: [22.4 PlayerRollingState implementieren](22.4-rolling-state.md)
