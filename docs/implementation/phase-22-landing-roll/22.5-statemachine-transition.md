# 22.5 StateMachine + FallingState Transition

> **Commit:** `feat(phase-22): 22.5 Roll StateMachine-Integration`
> **Branch:** `feat/roll-transitions`

---

## Ziel

`PlayerRollingState` in die StateMachine registrieren und die Landing-Logik in `PlayerFallingState` um die Roll-Bedingung erweitern.

---

## Anweisungen

### 1. PlayerMovementStateMachine erweitern

**Datei:** `Packages/Wiesenwischer.GameKit.CharacterController.Core/Runtime/Core/StateMachine/PlayerMovementStateMachine.cs`

**Property hinzufügen:**
```csharp
public PlayerRollingState RollingState { get; }
```

**Im Konstruktor instanziieren:**
```csharp
RollingState = new PlayerRollingState(this);
```

### 2. PlayerFallingState Landing-Logik erweitern

**Datei:** `Packages/Wiesenwischer.GameKit.CharacterController.Core/Runtime/Core/StateMachine/States/PlayerFallingState.cs`

Die bestehende Landing-Kategorisierung in der Landing-Methode muss erweitert werden.

**Aktuelle Logik (nach Phase 21):**
```
Bodenkontakt auf steilem Hang → SlidingState
landingSpeed >= HardThreshold → HardLandingState
else → SoftLandingState
```

**Neue Logik (Roll einfügen):**
```
Bodenkontakt auf steilem Hang → SlidingState
landingSpeed >= HardThreshold:
  → Roll-Bedingung erfüllt → RollingState
  → Sonst → HardLandingState
else → SoftLandingState
```

**Roll-Bedingung:**
```csharp
private bool ShouldRoll()
{
    if (!Config.RollEnabled) return false;

    return Config.RollTriggerMode switch
    {
        RollTriggerMode.MovementInput
            => ReusableData.MoveInput.sqrMagnitude > 0.01f,
        RollTriggerMode.ButtonPress
            => ReusableData.DashPressed,
        _ => false,
    };
}
```

**Integration in Landing-Methode:**
```csharp
// Nach Slope-Sliding-Check, bei hartem Aufprall:
if (landingSpeed >= Config.HardLandingThreshold)
{
    if (ShouldRoll())
    {
        ChangeState(StateMachine.RollingState);
        return;
    }
    ChangeState(StateMachine.HardLandingState);
    return;
}

// Weicher Aufprall:
ChangeState(StateMachine.SoftLandingState);
```

### 3. Hinweis: Phase 21 Impact

Phase 21 (Slope Sliding) hat die FallingState Landing-Logik bereits modifiziert (Slope-Check vor Landing-Kategorisierung). Die Roll-Bedingung wird **nach** dem Slope-Check, aber **vor** dem HardLanding eingefügt. Die Reihenfolge ist:

1. Steiler Hang → Sliding
2. Harter Aufprall + Roll-Bedingung → Rolling
3. Harter Aufprall ohne Roll → HardLanding
4. Weicher Aufprall → SoftLanding

---

## Verifikation

- [ ] `StateMachine.RollingState` Property existiert
- [ ] RollingState wird im Konstruktor instanziiert
- [ ] `ShouldRoll()` prüft `RollEnabled` und `RollTriggerMode`
- [ ] FallingState: Harter Aufprall + Movement-Input → RollingState
- [ ] FallingState: Harter Aufprall ohne Input → HardLandingState (unverändert)
- [ ] FallingState: Weicher Aufprall → SoftLandingState (unverändert)
- [ ] FallingState: Steiler Hang → SlidingState (unverändert)
- [ ] ButtonPress-Modus: `DashPressed` → Roll
- [ ] `RollEnabled = false` → Immer HardLanding
- [ ] Kompilierung fehlerfrei

---

## Erwartete Dateien

```
Packages/.../Runtime/Core/StateMachine/PlayerMovementStateMachine.cs   (GEÄNDERT)
Packages/.../Runtime/Core/StateMachine/States/PlayerFallingState.cs    (GEÄNDERT)
```

---

**Nächster Schritt:** [22.6 Unit Tests](22.6-unit-tests.md)
