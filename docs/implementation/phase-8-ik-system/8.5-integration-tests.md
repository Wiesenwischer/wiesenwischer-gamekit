# 8.5 Prefab-Integration & Tests

> **Branch:** `feat/ik-integration-tests`
> **Commit:** `feat(phase-8): 8.5 Prefab-Integration & Tests`

---

## Ziel

IK-Komponenten in das Player Prefab integrieren, Unit Tests für IK-Berechnungen schreiben und die Testszene für visuelle Verifikation vorbereiten.

---

## Dateien

| Aktion | Pfad |
|--------|------|
| Ändern | `Assets/Prefabs/Player.prefab` |
| Erstellen | `Packages/Wiesenwischer.GameKit.CharacterController.IK/Tests/Runtime/FootIKTests.cs` |
| Erstellen | `Packages/Wiesenwischer.GameKit.CharacterController.IK/Tests/Runtime/LookAtIKTests.cs` |
| Ändern | `Packages/Wiesenwischer.GameKit.CharacterController.Animation/Editor/AnimationTestSceneCreator.cs` |
| Ändern | `Packages/Wiesenwischer.GameKit.CharacterController.Animation/Editor/PlayerPrefabCreator.cs` |

---

## Detaillierte Anweisungen

### 1. Player Prefab Anpassung

Auf dem **CharacterModel** Child-Object (das mit dem Animator) müssen hinzugefügt werden:

```
Player (Root)
├── PlayerController
├── CharacterMotor
├── GroundingSmoother
└── CC_Character (CharacterModel mit Animator)
    ├── AnimatorParameterBridge (bestehend)
    ├── IKManager (NEU)
    ├── FootIK (NEU)
    ├── LookAtIK (NEU)
    └── CameraTargetProvider (NEU)
```

**Konfiguration IKManager:**
- `_playerController` → PlayerController (Parent)
- `_masterWeight` = 1.0
- `_disableDuringAirborne` = true

**Konfiguration FootIK:**
- `_playerController` → PlayerController (Parent)
- `_weight` = 1.0
- `_raycastHeight` = 0.5
- `_raycastDepth` = 0.3
- `_groundLayers` → gleiche Layer wie CharacterMotor's `StableGroundLayers`
- `_footOffset` = 0.02
- `_maxFootAdjustment` = 0.4

**Konfiguration LookAtIK:**
- `_targetProvider` → CameraTargetProvider (selbes GameObject)
- `_weight` = 1.0
- `_bodyWeight` = 0.2
- `_headWeight` = 0.8
- `_eyesWeight` = 0.0
- `_clampWeight` = 0.6

**Konfiguration CameraTargetProvider:**
- `_lookDistance` = 10

### 2. PlayerPrefabCreator Anpassung

Im `PlayerPrefabCreator.cs` die IK-Komponenten automatisch hinzufügen:

```csharp
// Nach AnimatorParameterBridge-Setup:
// IK Manager
var ikManager = characterModel.AddComponent<IKManager>();
// IK Manager Felder über SerializedObject setzen

// Foot IK
var footIK = characterModel.AddComponent<FootIK>();
// Foot IK Felder setzen

// LookAt IK
var cameraProvider = characterModel.AddComponent<CameraTargetProvider>();
var lookAtIK = characterModel.AddComponent<LookAtIK>();
// LookAt IK Felder setzen
```

**Hinweis:** Der `PlayerPrefabCreator` muss eine Referenz auf das IK-Package haben. Falls das zirkuläre Abhängigkeiten verursacht (Animation → IK), kann die IK-Setup-Logik stattdessen in einen eigenen `IKSetupWizard` im IK-Package ausgelagert werden. Alternativ kann ein optionaler `#if`-Block genutzt werden.

**Empfohlene Lösung:** Eigener Editor-Befehl im IK-Package:
```
Menü: Wiesenwischer > GameKit > Setup IK on Player Prefab
```

### 3. Unit Tests

#### FootIKTests.cs

```csharp
using NUnit.Framework;
using UnityEngine;

namespace Wiesenwischer.GameKit.CharacterController.IK.Tests
{
    [TestFixture]
    public class FootIKTests
    {
        [Test]
        public void BodyOffset_UsesMinOfBothFeet()
        {
            // Wenn linker Fuß -0.1 und rechter Fuß -0.2 unter Ground:
            // Body Offset = min(-0.1, -0.2) = -0.2
            float leftDelta = -0.1f;
            float rightDelta = -0.2f;
            float offset = Mathf.Min(leftDelta, rightDelta);
            offset = Mathf.Min(offset, 0f);
            Assert.AreEqual(-0.2f, offset, 0.001f);
        }

        [Test]
        public void BodyOffset_NeverPositive()
        {
            // Wenn beide Füße ÜBER dem Boden: Offset = 0
            float leftDelta = 0.1f;
            float rightDelta = 0.05f;
            float offset = Mathf.Min(leftDelta, rightDelta);
            offset = Mathf.Min(offset, 0f);
            Assert.AreEqual(0f, offset, 0.001f);
        }

        [Test]
        public void FootRotation_FlatGround_NoRotation()
        {
            Vector3 normal = Vector3.up;
            Quaternion rot = Quaternion.FromToRotation(Vector3.up, normal);
            Assert.AreEqual(Quaternion.identity, rot);
        }

        [Test]
        public void FootRotation_SlopedGround_Tilted()
        {
            Vector3 normal = new Vector3(0f, 0.866f, 0.5f).normalized; // ~30° Slope
            Quaternion rot = Quaternion.FromToRotation(Vector3.up, normal);
            // Rotation sollte NICHT identity sein
            Assert.AreNotEqual(Quaternion.identity, rot);
            // Angle ~30°
            float angle = Quaternion.Angle(Quaternion.identity, rot);
            Assert.AreEqual(30f, angle, 2f);
        }

        [Test]
        public void MaxAdjustment_ClampsExcessiveOffset()
        {
            float maxAdjust = 0.4f;
            float delta = -0.8f; // Zu viel
            float clamped = Mathf.Clamp(delta, -maxAdjust, maxAdjust);
            Assert.AreEqual(-0.4f, clamped, 0.001f);
        }
    }
}
```

#### LookAtIKTests.cs

```csharp
using NUnit.Framework;
using UnityEngine;

namespace Wiesenwischer.GameKit.CharacterController.IK.Tests
{
    [TestFixture]
    public class LookAtIKTests
    {
        [Test]
        public void Weight_ClampsTo01Range()
        {
            float weight = Mathf.Clamp01(1.5f);
            Assert.AreEqual(1f, weight);
            weight = Mathf.Clamp01(-0.5f);
            Assert.AreEqual(0f, weight);
        }

        [Test]
        public void SmoothLerp_ApproachesTarget()
        {
            Vector3 current = Vector3.zero;
            Vector3 target = new Vector3(10, 0, 0);
            float speed = 5f;
            float dt = 0.016f; // ~60fps

            current = Vector3.Lerp(current, target, speed * dt);
            // Nach einem Frame: sollte sich dem Target genähert haben
            Assert.Greater(current.x, 0f);
            Assert.Less(current.x, 10f);
        }

        [Test]
        public void LookDistance_ProducesForwardTarget()
        {
            Vector3 cameraPos = new Vector3(0, 5, -10);
            Vector3 cameraForward = Vector3.forward;
            float lookDistance = 10f;

            Vector3 target = cameraPos + cameraForward * lookDistance;
            Assert.AreEqual(new Vector3(0, 5, 0), target);
        }
    }
}
```

### 4. AnimationTestScene Erweiterung

Optional: Unebenes Terrain in die Testszene einfügen für bessere IK-Tests:

```csharp
// In AnimationTestSceneCreator.CreateTestScene():

// === Unebener Boden für FootIK-Tests ===
CreateUnevenGround(new Vector3(5f, 0f, 10f), groundMat);
```

```csharp
private static void CreateUnevenGround(Vector3 startPos, Material mat)
{
    var parent = new GameObject("UnevenGround_IK_Test");
    parent.transform.position = startPos;

    // Verschieden hohe Blöcke nebeneinander
    float[] heights = { 0.1f, 0.0f, 0.15f, 0.05f, 0.2f, 0.0f, 0.1f, 0.25f };
    for (int i = 0; i < heights.Length; i++)
    {
        var block = GameObject.CreatePrimitive(PrimitiveType.Cube);
        block.name = $"Ground_{i}";
        block.transform.SetParent(parent.transform);
        block.transform.localPosition = new Vector3(0f, heights[i] * 0.5f, -i * 0.5f);
        block.transform.localScale = new Vector3(3f, heights[i] + 0.2f, 0.5f);
        block.GetComponent<Renderer>().sharedMaterial = mat;
    }
}
```

---

## Verifikation

### Code-Verifikation
- [ ] IKManager, FootIK, LookAtIK, CameraTargetProvider auf Player Prefab
- [ ] Alle Referenzen korrekt verdrahtet (PlayerController, TargetProvider)
- [ ] GroundLayers auf FootIK stimmt mit Motor überein
- [ ] Unit Tests kompilieren und laufen grün
- [ ] Keine Kompilierungsfehler in allen Packages

### Visuelle Verifikation (Test-Checkliste)

1. **Play Mode starten** in der AnimationTestScene
2. **Foot IK auf Treppen:**
   - [ ] Füße stehen auf den Stufenoberflächen (nicht in der Luft / nicht im Boden)
   - [ ] Bei Stehen auf einer Stufe: Hüfte leicht abgesenkt (Body Offset)
   - [ ] Smooth Transition beim Betreten/Verlassen der Treppe
3. **Foot IK auf Slopes:**
   - [ ] Füße liegen flach auf dem Hang (angepasste Rotation)
   - [ ] Kein Clipping durch den Boden
4. **LookAt IK:**
   - [ ] Kopf dreht sich zur Kamera-Blickrichtung
   - [ ] Oberkörper neigt sich leicht mit
   - [ ] Smooth Transition bei Kameradrehung
   - [ ] Kein Zucken bei schnellen Kamerabewegungen
5. **Airborne:**
   - [ ] IK deaktiviert während Jump/Fall
   - [ ] Smooth Ausblenden beim Absprung
   - [ ] Smooth Einblenden bei Landung
6. **Performance:**
   - [ ] Profiler: Raycasts pro Frame = 2 (left + right foot)
   - [ ] Kein GC-Alloc in Update-Loop

---

## Nächster Schritt

→ Phase abgeschlossen. Nächstes Epic: Phase 5 (Ability System) oder Phase 11 (Character Platform).
