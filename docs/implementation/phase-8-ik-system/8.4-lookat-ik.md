# 8.4 LookAtIK Modul

> **Branch:** `feat/ik-foot-lookat`
> **Commit:** `feat(phase-8): 8.4 LookAtIK Modul`

---

## Ziel

`LookAtIK` Modul implementieren, das den Kopf und Oberkörper des Characters zum Kamera-Ziel drehen lässt. Der Character schaut aktiv in die Richtung, in die die Kamera blickt — natürlicher als starrer Blick nach vorne.

---

## Dateien

| Aktion | Pfad |
|--------|------|
| Erstellen | `Packages/Wiesenwischer.GameKit.CharacterController.IK/Runtime/Modules/LookAtIK.cs` |

---

## Konzept

### Unity LookAt IK API

Unity bietet eine eingebaute LookAt-IK mit gewichteten Körperteilen:

```csharp
animator.SetLookAtPosition(target);
animator.SetLookAtWeight(
    weight,         // Gesamt-Weight
    bodyWeight,     // Wie stark der Körper sich mitdreht
    headWeight,     // Kopf-Rotation
    eyesWeight,     // Augen-Rotation (Blend Shapes nötig)
    clampWeight     // Begrenzung des Drehwinkels
);
```

### Gewichtung

| Körperteil | Weight | Effekt |
|-----------|--------|--------|
| Body | 0.1–0.3 | Leichte Oberkörper-Neigung zur Blickrichtung |
| Head | 0.7–1.0 | Hauptdrehung des Kopfes |
| Eyes | 0.0 | Deaktiviert (CC-Modelle haben keine Eye BlendShapes) |
| Clamp | 0.5–0.8 | Begrenzt extreme Drehwinkel |

---

## Detaillierte Anweisungen

### Klassen-Struktur

```csharp
using UnityEngine;

namespace Wiesenwischer.GameKit.CharacterController.IK.Modules
{
    /// <summary>
    /// LookAt IK Modul: Dreht Kopf und Oberkörper zum Blickziel.
    /// Nutzt Unity's eingebaute SetLookAtPosition/Weight API.
    /// Das Target kommt von einem IIKTargetProvider (z.B. CameraTargetProvider).
    /// </summary>
    public class LookAtIK : MonoBehaviour, IIKModule
    {
        // ... (siehe unten)
    }
}
```

### Serialisierte Felder

| Feld | Typ | Default | Beschreibung |
|------|-----|---------|-------------|
| `_targetProvider` | MonoBehaviour (IIKTargetProvider) | — | Referenz auf den Target-Provider |
| `_weight` | float | 1.0 | Gesamt-IK-Weight |
| `_bodyWeight` | float | 0.2 | Wie stark sich der Oberkörper mitdreht |
| `_headWeight` | float | 0.8 | Kopf-Rotations-Stärke |
| `_eyesWeight` | float | 0.0 | Augen-Rotation (deaktiviert für CC-Modelle) |
| `_clampWeight` | float | 0.6 | Begrenzt extreme Drehwinkel |
| `_smoothSpeed` | float | 5f | Wie schnell der LookAt-Weight sich ändert |

**Hinweis zu `_targetProvider`:** Unity serialisiert keine Interfaces. Daher `[SerializeField] private MonoBehaviour _targetProvider;` und in `Awake()` casten: `_target = _targetProvider as IIKTargetProvider`.

### Private Felder

```csharp
private bool _isEnabled = true;
private IKManager _ikManager;
private IIKTargetProvider _target;
private float _currentWeight;
private Vector3 _currentLookTarget;
```

### Awake & Registrierung

```csharp
private void Awake()
{
    _ikManager = GetComponent<IKManager>();
    _target = _targetProvider as IIKTargetProvider;

    if (_target == null)
    {
        // Fallback: CameraTargetProvider auf dem selben GameObject suchen
        _target = GetComponent<IIKTargetProvider>();
    }
}

private void OnEnable()
{
    _ikManager?.RegisterModule(this);
}

private void OnDisable()
{
    _ikManager?.UnregisterModule(this);
}
```

### PrepareIK

```csharp
public void PrepareIK()
{
    // Target-Weight: Sanft ein-/ausblenden wenn Target vorhanden/nicht vorhanden
    float targetWeight = (_target != null && _target.HasLookTarget) ? _weight : 0f;
    _currentWeight = Mathf.MoveTowards(_currentWeight, targetWeight,
        _smoothSpeed * Time.deltaTime);

    // Target-Position smooth verfolgen (verhindert Zucken)
    if (_target != null && _target.HasLookTarget)
    {
        Vector3 newTarget = _target.GetLookTarget();
        _currentLookTarget = Vector3.Lerp(_currentLookTarget, newTarget,
            _smoothSpeed * Time.deltaTime);
    }
}
```

### ProcessIK

```csharp
public void ProcessIK(Animator animator, int layerIndex)
{
    if (layerIndex != 0) return; // LookAt nur auf Base Layer

    if (_currentWeight <= 0.01f)
    {
        animator.SetLookAtWeight(0f);
        return;
    }

    animator.SetLookAtPosition(_currentLookTarget);
    animator.SetLookAtWeight(
        _currentWeight,
        _bodyWeight,
        _headWeight,
        _eyesWeight,
        _clampWeight);
}
```

### IIKModule Interface

```csharp
public string Name => "LookAtIK";
public bool IsEnabled { get => _isEnabled; set => _isEnabled = value; }
public float Weight { get => _weight; set => _weight = Mathf.Clamp01(value); }
```

---

## Verhalten

### Normaler Betrieb
- Character schaut in die Kamera-Blickrichtung
- Kopf dreht sich, Oberkörper neigt sich leicht mit
- Smooth Interpolation verhindert abrupte Kopfbewegungen

### Wenn Character sich dreht
- LookAt-Target bewegt sich mit der Kamera
- Body-Rotation (vom Motor) + LookAt-IK ergänzen sich
- Bei Rotation > ~120° vom Target: Clamp begrenzt den Winkel

### Während Airborne
- Der `IKManager` deaktiviert IK global (`_disableDuringAirborne`)
- Alternativ: LookAtIK könnte auch in der Luft aktiv bleiben (konfigurierbar)
- Default: Aus, damit keine IK-Artefakte beim Fallen entstehen

---

## Edge Cases

### 1. Kein Target-Provider
Wenn `_target == null`, bleibt `_currentWeight` bei 0 → kein LookAt-Effekt. Kein Fehler.

### 2. Target hinter dem Character
Der `_clampWeight` verhindert, dass der Kopf sich um 180° dreht. Bei extremen Winkeln wird das LookAt stattdessen sanft ausgeblendet.

### 3. Kombination mit Abilities (Zukunft)
Wenn ein Spell-Cast eine eigene Blickrichtung hat, kann ein spezieller `IIKTargetProvider` das LookAt-Target überschreiben (z.B. auf den Gegner statt die Kamera-Richtung).

---

## Verifikation

- [ ] `LookAtIK.cs` erstellt unter `Runtime/Modules/`
- [ ] Implementiert `IIKModule` Interface vollständig
- [ ] Registriert sich bei `IKManager` in `OnEnable` / `OnDisable`
- [ ] `_targetProvider` als `MonoBehaviour` serialisiert, Cast zu `IIKTargetProvider`
- [ ] `PrepareIK()` interpoliert Weight und Position smooth
- [ ] `ProcessIK()` nutzt `SetLookAtPosition()` + `SetLookAtWeight()`
- [ ] Kein IK bei `_currentWeight <= 0.01`
- [ ] Kompiliert fehlerfrei

---

## Nächster Schritt

→ [8.5 Prefab-Integration & Tests](8.5-integration-tests.md)
