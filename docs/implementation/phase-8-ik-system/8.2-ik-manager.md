# 8.2 IKManager Komponente

> **Branch:** `feat/ik-package-interfaces`
> **Commit:** `feat(phase-8): 8.2 IKManager Komponente`

---

## Ziel

`IKManager` MonoBehaviour erstellen, der als zentrale Stelle für IK-Module dient. Er registriert Module, ruft sie im `OnAnimatorIK`-Callback auf und ermöglicht globale Steuerung (alles an/aus, Master-Weight).

---

## Dateien

| Aktion | Pfad |
|--------|------|
| Erstellen | `Packages/Wiesenwischer.GameKit.CharacterController.IK/Runtime/Core/IKManager.cs` |
| Erstellen | `Packages/Wiesenwischer.GameKit.CharacterController.IK/Runtime/Core/CameraTargetProvider.cs` |

---

## Detaillierte Anweisungen

### Platzierung

Der `IKManager` muss auf dem **selben GameObject wie der Animator** liegen, weil Unity `OnAnimatorIK` nur auf dem Animator-GameObject aufruft. Das ist das CharacterModel-Child (nicht der Root-PlayerController).

```
Player (Root)
├── PlayerController
├── CharacterMotor
└── CharacterModel (Animator hier)      ← IKManager hier
    ├── AnimatorParameterBridge
    └── IKManager (NEU)
        ├── FootIK (als Modul registriert)
        └── LookAtIK (als Modul registriert)
```

### IKManager Klassen-Struktur

```csharp
using System.Collections.Generic;
using UnityEngine;
using Wiesenwischer.GameKit.CharacterController.Core;

namespace Wiesenwischer.GameKit.CharacterController.IK
{
    /// <summary>
    /// Orchestriert IK-Module. Ruft registrierte Module im OnAnimatorIK-Callback
    /// auf und ermöglicht globale Steuerung (Master-Weight, Enable/Disable).
    /// Muss auf dem selben GameObject wie der Animator liegen.
    /// </summary>
    [RequireComponent(typeof(Animator))]
    public class IKManager : MonoBehaviour
    {
        [Header("References")]
        [SerializeField] private PlayerController _playerController;

        [Header("Global Settings")]
        [Tooltip("Master-Weight für alle IK-Module. 0 = alles aus, 1 = voller Einfluss.")]
        [Range(0f, 1f)]
        [SerializeField] private float _masterWeight = 1f;

        [Tooltip("IK deaktivieren während bestimmter Zustände (Jump, Fall, Land).")]
        [SerializeField] private bool _disableDuringAirborne = true;

        private Animator _animator;
        private readonly List<IIKModule> _modules = new List<IIKModule>();
        private bool _isValid;

        public float MasterWeight
        {
            get => _masterWeight;
            set => _masterWeight = Mathf.Clamp01(value);
        }

        // ... (siehe unten)
    }
}
```

### Serialisierte Felder

| Feld | Typ | Default | Beschreibung |
|------|-----|---------|-------------|
| `_playerController` | PlayerController | — | Referenz zum PlayerController (GetComponentInParent Fallback) |
| `_masterWeight` | float | 1.0 | Globaler IK-Weight (0=aus, 1=an) |
| `_disableDuringAirborne` | bool | true | IK aus während Jump/Fall/Land |

### Awake & OnEnable

```csharp
private void Awake()
{
    _animator = GetComponent<Animator>();
    if (_playerController == null)
        _playerController = GetComponentInParent<PlayerController>();
}

private void OnEnable()
{
    _isValid = _animator != null && _playerController != null;
}
```

### Modul-Registrierung

```csharp
public void RegisterModule(IIKModule module)
{
    if (module != null && !_modules.Contains(module))
        _modules.Add(module);
}

public void UnregisterModule(IIKModule module)
{
    _modules.Remove(module);
}

public T GetModule<T>() where T : class, IIKModule
{
    for (int i = 0; i < _modules.Count; i++)
    {
        if (_modules[i] is T typed) return typed;
    }
    return null;
}
```

### LateUpdate — PrepareIK

Module berechnen ihre IK-Ziele in `PrepareIK()` (z.B. Raycasts für FootIK). Das passiert in `LateUpdate`, getrennt vom `OnAnimatorIK`-Callback.

```csharp
private void LateUpdate()
{
    if (!_isValid) return;
    if (GetEffectiveWeight() <= 0f) return;

    for (int i = 0; i < _modules.Count; i++)
    {
        if (_modules[i].IsEnabled)
            _modules[i].PrepareIK();
    }
}
```

### OnAnimatorIK — ProcessIK

```csharp
private void OnAnimatorIK(int layerIndex)
{
    if (!_isValid) return;

    float effectiveWeight = GetEffectiveWeight();
    if (effectiveWeight <= 0f) return;

    for (int i = 0; i < _modules.Count; i++)
    {
        var module = _modules[i];
        if (module.IsEnabled && module.Weight > 0f)
        {
            module.ProcessIK(_animator, layerIndex);
        }
    }
}
```

### Effective Weight Berechnung

```csharp
private float GetEffectiveWeight()
{
    if (_masterWeight <= 0f) return 0f;

    // Airborne-Check: IK reduzieren/deaktivieren wenn nicht am Boden
    if (_disableDuringAirborne && !_playerController.IsGrounded)
        return 0f;

    return _masterWeight;
}
```

### CameraTargetProvider

Standard-`IIKTargetProvider` der das Kamera-Zentrum als LookAt-Target liefert:

```csharp
using UnityEngine;

namespace Wiesenwischer.GameKit.CharacterController.IK
{
    /// <summary>
    /// Standard IIKTargetProvider: Nutzt die Hauptkamera als LookAt-Ziel.
    /// Der Blickpunkt ist Camera.main.transform.position + forward * distance.
    /// </summary>
    public class CameraTargetProvider : MonoBehaviour, IIKTargetProvider
    {
        [Tooltip("Entfernung des LookAt-Ziels vor der Kamera.")]
        [SerializeField] private float _lookDistance = 10f;

        private Camera _camera;

        private void Awake()
        {
            _camera = Camera.main;
        }

        public Vector3 GetLookTarget()
        {
            if (_camera == null) return transform.position + transform.forward;
            return _camera.transform.position + _camera.transform.forward * _lookDistance;
        }

        public bool HasLookTarget => _camera != null;
    }
}
```

---

## Verifikation

- [ ] `IKManager.cs` erstellt unter `Runtime/Core/`
- [ ] `[RequireComponent(typeof(Animator))]` vorhanden
- [ ] `RegisterModule()` / `UnregisterModule()` / `GetModule<T>()` implementiert
- [ ] `LateUpdate()` ruft `PrepareIK()` auf allen aktiven Modulen auf
- [ ] `OnAnimatorIK()` ruft `ProcessIK()` auf allen aktiven Modulen auf
- [ ] `GetEffectiveWeight()` prüft `_masterWeight` und Airborne-Zustand
- [ ] `CameraTargetProvider.cs` implementiert `IIKTargetProvider`
- [ ] Kein GC-Alloc pro Frame (keine LINQ, kein `new` auf Heap-Objekte)
- [ ] Kompiliert fehlerfrei

---

## Nächster Schritt

→ [8.3 FootIK Modul](8.3-foot-ik.md)
