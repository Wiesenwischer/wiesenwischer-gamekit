# 3.1 PlayerController Animation-Anbindung

**Commit:** `feat(phase-3): 3.1 PlayerController Animation-Anbindung`
**Branch:** `feat/animation-controller-binding`

---

## Ziel

Den `PlayerController` um eine `IAnimationController`-Referenz erweitern und diese über die `PlayerMovementStateMachine` für alle States zugänglich machen. Zusätzlich das `IAnimationController`-Interface um `TriggerLanding(bool)` erweitern.

---

## Änderungen

### 1. IAnimationController erweitern

**Datei:** `Packages/Wiesenwischer.GameKit.CharacterController.Animation/Runtime/Core/IAnimationController.cs`

Die Methode `TriggerLanding(bool isHardLanding)` zum Interface hinzufügen. Die `AnimatorParameterBridge` implementiert diese bereits (Phase 2.5), aber das Interface muss sie deklarieren.

```csharp
namespace Wiesenwischer.GameKit.CharacterController.Animation
{
    public interface IAnimationController
    {
        void SetSpeed(float speed);
        void SetGrounded(bool isGrounded);
        void SetVerticalVelocity(float velocity);
        void TriggerJump();
        void TriggerLand();

        /// <summary>
        /// Setzt den HardLanding-Parameter und triggert die Land-Animation.
        /// Kombiniert SetHardLanding + TriggerLand in einem Aufruf.
        /// </summary>
        void TriggerLanding(bool isHardLanding);

        void SetAbilityLayerWeight(float weight);
    }
}
```

> **Hinweis:** `TriggerLanding(bool)` existiert bereits in der `AnimatorParameterBridge` (Phase 2.5). Durch die Interface-Erweiterung wird sie nun Teil des offiziellen Contracts.

---

### 2. PlayerController erweitern

**Datei:** `Packages/Wiesenwischer.GameKit.CharacterController.Core/Runtime/Core/PlayerController.cs`

Da `PlayerController` im **Core**-Package liegt und `IAnimationController` im **Animation**-Package, darf Core nicht direkt auf Animation referenzieren (Abhängigkeitsrichtung: Animation → Core).

**Lösung:** Das Interface `IAnimationController` in das **Core**-Package verschieben, da es ein reines Interface ohne Unity-Animation-Abhängigkeiten ist.

**Alternative:** Falls das Interface im Animation-Package bleiben soll, kann der PlayerController ein generisches `System.Object`-Feld verwenden und die States casten. **Empfohlen wird aber die Verschiebung ins Core-Package.**

#### Option A: Interface ins Core-Package verschieben (empfohlen)

**Neue Datei:** `Packages/Wiesenwischer.GameKit.CharacterController.Core/Runtime/Core/Animation/IAnimationController.cs`

```csharp
namespace Wiesenwischer.GameKit.CharacterController.Core.Animation
{
    /// <summary>
    /// Interface für Animation-Steuerung.
    /// Liegt im Core-Package, damit PlayerController und States darauf zugreifen können.
    /// Implementierung liegt im Animation-Package (AnimatorParameterBridge).
    /// </summary>
    public interface IAnimationController
    {
        void SetSpeed(float speed);
        void SetGrounded(bool isGrounded);
        void SetVerticalVelocity(float velocity);
        void TriggerJump();
        void TriggerLand();
        void TriggerLanding(bool isHardLanding);
        void SetAbilityLayerWeight(float weight);
    }
}
```

Dann die alte `IAnimationController.cs` im Animation-Package löschen und den Namespace-Import in `AnimatorParameterBridge.cs` anpassen:

```csharp
using Wiesenwischer.GameKit.CharacterController.Core.Animation;
```

#### Änderungen am PlayerController

```csharp
// Neues using:
using Wiesenwischer.GameKit.CharacterController.Core.Animation;

// Neues Property (in der Properties-Region):
public IAnimationController AnimationController { get; private set; }

// In Awake() oder InitializeComponents():
private void InitializeAnimationController()
{
    AnimationController = GetComponentInChildren<IAnimationController>() as IAnimationController;

    if (AnimationController == null)
        Debug.LogWarning("[PlayerController] Kein IAnimationController gefunden. " +
                         "Animationen werden nicht abgespielt.");
}
```

> **Wichtig:** `GetComponentInChildren<T>()` funktioniert mit Interfaces in Unity. Da die `AnimatorParameterBridge` auf dem Character-Model-Child-Object sitzt, wird sie dort gefunden.

---

### 3. PlayerMovementStateMachine: Animation-Zugriff

**Datei:** `Packages/Wiesenwischer.GameKit.CharacterController.Core/Runtime/Core/StateMachine/PlayerMovementStateMachine.cs`

States brauchen Zugriff auf den AnimationController. Da sie bereits `Player` (den PlayerController) kennen, reicht ein Shortcut-Property nicht — aber der Zugriff über `Player.AnimationController` ist direkt möglich.

Kein neues Property in der StateMachine nötig. States greifen über den bestehenden Pfad zu:

```csharp
// In jedem State:
Player.AnimationController?.TriggerJump();
```

Der Null-Conditional-Operator `?.` stellt sicher, dass ohne AnimationController keine Fehler auftreten (z.B. in Unit Tests ohne Animator).

---

### 4. LocomotionConfig Zugriff sicherstellen

Die `AnimatorParameterBridge` braucht Zugriff auf `LocomotionConfig.RunSpeed` für die Speed-Normalisierung. Prüfen ob `PlayerController.LocomotionConfig` bereits public ist.

Falls nicht, sicherstellen dass das Property öffentlich zugänglich ist:

```csharp
// In PlayerController.cs (sollte bereits existieren):
public LocomotionConfig LocomotionConfig => _locomotionConfig;
```

---

## Verifikation

- [ ] `IAnimationController` Interface im Core-Package unter `Runtime/Core/Animation/`
- [ ] Interface enthält `TriggerLanding(bool isHardLanding)`
- [ ] Alte `IAnimationController.cs` im Animation-Package gelöscht oder als Re-Export
- [ ] `AnimatorParameterBridge` verwendet neuen Namespace
- [ ] `PlayerController.AnimationController` Property vorhanden
- [ ] `GetComponentInChildren<IAnimationController>()` in Initialisierung
- [ ] Null-Check mit Warning-Log falls kein AnimationController gefunden
- [ ] `LocomotionConfig` öffentlich zugänglich
- [ ] Alle Packages kompilieren fehlerfrei

### Compiler prüfen

```bash
powershell -Command "Get-Content 'C:\Users\marcu\AppData\Local\Unity\Editor\Editor.log' -Tail 100 | Select-String -Pattern 'error|CS\d{4}'"
```

---

## Dateien nach diesem Schritt

```
Packages/Wiesenwischer.GameKit.CharacterController.Core/
├── Runtime/Core/
│   ├── Animation/
│   │   └── IAnimationController.cs          (NEU - aus Animation-Package verschoben)
│   ├── PlayerController.cs                  (GEÄNDERT - AnimationController Property)
│   └── ...

Packages/Wiesenwischer.GameKit.CharacterController.Animation/
├── Runtime/Core/
│   ├── IAnimationController.cs              (GELÖSCHT - nach Core verschoben)
│   ├── AnimationParameters.cs               (unverändert)
│   └── AnimatorParameterBridge.cs           (GEÄNDERT - neuer using-Namespace)
```

---

## Nächster Schritt

[3.2 State Animation-Trigger](3.2-state-animation-triggers.md)
