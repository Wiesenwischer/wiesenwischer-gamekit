# 3.3 Player Prefab zusammenbauen

**Commit:** `feat(phase-3): 3.3 Player Prefab zusammenbauen`
**Branch:** `feat/animated-player-prefab`

---

## Ziel

Das Player Prefab mit allen Komponenten zusammenbauen, sodass der Character animiert durch die Welt laufen, springen und landen kann.

---

## Prefab-Hierarchie

```
Player (Root GameObject)
│
├── Components auf Root:
│   ├── PlayerController
│   │   ├── _locomotionConfig → LocomotionConfig (ScriptableObject)
│   │   └── _inputProvider → (wird per GetComponent oder Injection gesetzt)
│   ├── CharacterMotor (KCC)
│   ├── CapsuleCollider (vom Motor verwaltet)
│   └── [Optional] InputProvider-Komponente
│
└── CharacterModel (Child GameObject)
    ├── SkinnedMeshRenderer (vom FBX)
    ├── Animator
    │   ├── Controller → CharacterAnimatorController (aus Phase 2)
    │   ├── Avatar → Humanoid Avatar (aus Phase 1)
    │   └── Apply Root Motion → false
    └── AnimatorParameterBridge
        └── _playerController → Player (Root, wird auto-resolved via GetComponentInParent)
```

---

## Schritt-für-Schritt Aufbau

### 1. Root GameObject erstellen

1. Neues leeres GameObject: `Player`
2. Komponenten hinzufügen:
   - `PlayerController`
   - `CharacterMotor` (KCC Motor)
3. `LocomotionConfig` ScriptableObject zuweisen

### 2. Character Model einbinden

1. Das in Phase 1 importierte Character-FBX als Child von `Player` platzieren
2. Benennung: `CharacterModel`

### 3. Animator konfigurieren

Das FBX-Child hat bereits einen `Animator` (Unity fügt diesen bei Humanoid-Import automatisch hinzu).

Konfiguration:
| Eigenschaft | Wert |
|-------------|------|
| Controller | `CharacterAnimatorController` (aus Phase 2.2) |
| Avatar | Humanoid Avatar (aus Phase 1.2) |
| Apply Root Motion | `false` |
| Update Mode | `Normal` |
| Culling Mode | `Cull Update Transforms` |

> **Apply Root Motion = false** ist kritisch! Die Bewegung wird von `CharacterLocomotion` / `CharacterMotor` gesteuert, nicht vom Animator. Root Motion würde zu doppelter Bewegung führen.

### 4. AnimatorParameterBridge hinzufügen

1. Auf dem `CharacterModel`-GameObject (gleich wie Animator):
   - Komponente `AnimatorParameterBridge` hinzufügen
2. Die Bridge findet den `PlayerController` automatisch via `GetComponentInParent<PlayerController>()` (siehe Phase 2.5)
3. Die Bridge findet den `Animator` automatisch via `GetComponent<Animator>()` (`[RequireComponent]`)

### 5. Serialized Fields prüfen

| Komponente | Feld | Wert |
|-----------|------|------|
| AnimatorParameterBridge | `_playerController` | Auto (GetComponentInParent) oder manuell zuweisen |
| AnimatorParameterBridge | `_speedDampTime` | `0.1` (Default) |
| AnimatorParameterBridge | `_verticalVelocityDampTime` | `0.05` (Default) |

### 6. Prefab speichern

1. Player-GameObject aus der Hierarchy in den Project-Ordner ziehen
2. Empfohlener Pfad: `Assets/Prefabs/Player.prefab`
3. Als Prefab-Variant oder Original speichern

---

## Animator Controller Zuweisung

Falls der Animator Controller noch nicht zugewiesen ist:

**Pfad:** `Packages/Wiesenwischer.GameKit.CharacterController.Animation/Resources/AnimatorControllers/CharacterAnimatorController.controller`

> **Hinweis:** Falls der Controller unter `Resources/` im Package liegt, kann er auch per `Resources.Load()` geladen werden. Für das Prefab ist die direkte Zuweisung im Inspector einfacher.

---

## Layer-Überprüfung im Animator

Nach dem Zusammenbau im Inspector prüfen:

| Layer | Weight | Mask | Blending |
|-------|--------|------|----------|
| Base Movement | 1.0 | None | Override |
| Abilities | 0.0 | UpperBody Mask | Override |
| Status | 0.0 | None | Override |

---

## Verifikation

### Im Inspector prüfen:
- [ ] Player hat `PlayerController` mit zugewiesenem `LocomotionConfig`
- [ ] Player hat `CharacterMotor`
- [ ] CharacterModel ist Child von Player
- [ ] CharacterModel hat `Animator` mit korrekt zugewiesenem Controller und Avatar
- [ ] `Apply Root Motion` ist **deaktiviert**
- [ ] CharacterModel hat `AnimatorParameterBridge`
- [ ] Bridge hat Referenz auf PlayerController (auto oder manuell)

### Im Play Mode prüfen:
- [ ] Kein Compiler-Fehler
- [ ] Character steht in Idle-Animation
- [ ] Beim Bewegen wechselt die Animation (Walk/Run/Sprint)
- [ ] Beim Springen spielt die Jump-Animation
- [ ] Beim Fallen spielt die Fall-Animation
- [ ] Bei Landung spielt die Landing-Animation

### Compiler prüfen

```bash
powershell -Command "Get-Content 'C:\Users\marcu\AppData\Local\Unity\Editor\Editor.log' -Tail 100 | Select-String -Pattern 'error|CS\d{4}'"
```

---

## Dateien nach diesem Schritt

```
Assets/
├── Prefabs/
│   └── Player.prefab                       (NEU)
```

> **Hinweis:** Das Prefab ist ein Unity-Asset (.prefab), keine Code-Datei. Es wird manuell im Unity Editor erstellt und im Projekt gespeichert.

---

## Nächster Schritt

[3.4 Test-Szene & Verifikation](3.4-test-verification.md)
