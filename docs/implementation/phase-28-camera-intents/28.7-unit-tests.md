# 28.7 Unit Tests

> **Commit:** `test(phase-28): 28.7 Unit Tests für Intent System, Presets und neue Behaviours`
> **Branch:** `test/camera-intents-presets` (vom Integration-Branch)

---

## Ziel

Umfassende Unit Tests für alle neuen Komponenten aus Phase 28:
- ICameraIntent Resolution
- CameraPreset + ICameraPresetReceiver
- DynamicOrbitCenterBehaviour
- SoftTargetingBehaviour
- CinemachineDriver (Basis-Tests)

---

## Test-Assemblies

### Camera.Core Tests (Erweiterung)

**Pfad:** `Packages/Wiesenwischer.GameKit.Camera.Core/Tests/Runtime/`

Neue Dateien:
- `IntentResolutionTests.cs`
- `CameraPresetTests.cs`

### Camera.Behaviours Tests (Erweiterung)

**Pfad:** `Packages/Wiesenwischer.GameKit.Camera.Behaviours/Tests/Runtime/`

Neue Dateien:
- `DynamicOrbitCenterTests.cs`
- `SoftTargetingTests.cs`

---

## Test-Spezifikationen

### 1. IntentResolutionTests

```csharp
[TestFixture]
public class IntentResolutionTests
{
    // --- Test-Helfer ---
    // MockIntent: Implementiert ICameraIntent, konfigurierbar für Priority, IsActive, Apply-Aktion

    [Test]
    public void SingleIntent_AppliesModification()
    // Ein Intent der Yaw um 10° verschiebt → State.Yaw = 10

    [Test]
    public void MultipleIntents_AppliedInPriorityOrder()
    // Intent A (Priority 100) setzt Yaw=10
    // Intent B (Priority 200) setzt Yaw=20
    // Ergebnis: Yaw=20 (B überschreibt A, weil höhere Priorität zuletzt)

    [Test]
    public void InactiveIntent_IsSkipped()
    // Intent mit IsActive=false → State bleibt unverändert

    [Test]
    public void PushIntent_AddsSorted()
    // Intents in falscher Reihenfolge pushen → intern korrekt sortiert

    [Test]
    public void RemoveIntent_RemovesFromList()
    // Intent pushen, dann entfernen → wird nicht mehr angewendet

    [Test]
    public void ClearIntents_RemovesAll()
    // Mehrere Intents pushen → ClearIntents → keine werden angewendet

    [Test]
    public void AdditiveIntents_StackCorrectly()
    // Intent A addiert Yaw+5, Intent B addiert Yaw+10 → Yaw=15
}
```

### 2. CameraPresetTests

```csharp
[TestFixture]
public class CameraPresetTests
{
    [Test]
    public void CameraPreset_HasDefaultValues()
    // Neues CameraPreset erstellen → Default-Werte prüfen

    [Test]
    public void PresetReceiver_ReceivesValues()
    // Mock-Behaviour mit ICameraPresetReceiver
    // SetPreset() aufrufen → ApplyPreset wurde aufgerufen

    [Test]
    public void SetPreset_UpdatesFov()
    // Preset mit Fov=55 → State.Fov = 55

    [Test]
    public void SetPreset_NullPreset_DoesNotThrow()
    // SetPreset(null) → kein Fehler

    [Test]
    public void SetPreset_SkipsNonReceivers()
    // Behaviour ohne ICameraPresetReceiver → kein Fehler, wird übersprungen
}
```

### 3. DynamicOrbitCenterTests

```csharp
[TestFixture]
public class DynamicOrbitCenterTests
{
    // Setup: DynamicOrbitCenterBehaviour erstellen, Default-CameraContext

    [Test]
    public void Idle_NoOffsetApplied()
    // CharacterVelocity = 0 → AnchorPosition unverändert

    [Test]
    public void Movement_ShiftsAnchorForward()
    // CharacterVelocity = (0,0,5) → AnchorPosition.z erhöht
    // (nach mehreren Frames wegen SmoothDamp)

    [Test]
    public void LookTarget_ShiftsTowardsMidpoint()
    // LookTarget gesetzt → AnchorPosition verschiebt sich Richtung Target

    [Test]
    public void LookTarget_HasPriorityOverMovement()
    // Beides aktiv (Velocity + LookTarget) → Target-Midpoint wird verwendet

    [Test]
    public void BelowMinSpeed_NoForwardBias()
    // CharacterVelocity < MinSpeed → kein Offset

    [Test]
    public void Snap_ResetsOffset()
    // Erst Offset aufbauen, dann Snap() → Offset = 0

    [Test]
    public void Disabled_NoUpdate()
    // enabled = false → AnchorPosition unverändert

    [Test]
    public void ApplyPreset_SetsValues()
    // Preset mit ForwardBias=1.0 → _forwardBias = 1.0
    // Preset mit DynamicOrbitEnabled=false → enabled = false
}
```

### 4. SoftTargetingTests

```csharp
[TestFixture]
public class SoftTargetingTests
{
    // Setup: SoftTargetingBehaviour erstellen, Default-CameraState + CameraContext

    [Test]
    public void NoTargetNoMovement_NoBias()
    // Kein LookTarget, Velocity=0 → Yaw unverändert

    [Test]
    public void Movement_AddsYawBias()
    // CharacterVelocity seitlich → Yaw wird leicht in Bewegungsrichtung verschoben
    // (nach mehreren Frames wegen SmoothDamp)

    [Test]
    public void LookTarget_AddsTargetBias()
    // LookTarget links → Yaw wird nach links gebiased

    [Test]
    public void LookTarget_OutOfRange_NoBias()
    // LookTarget > _targetRange → kein Bias

    [Test]
    public void LookTarget_HasPriorityOverMovement()
    // Beides aktiv → Target-Bias statt Movement-Bias

    [Test]
    public void BiasIsClamped()
    // Extremer Winkel zum Target → Bias max. _targetBiasStrength Grad

    [Test]
    public void BiasIsSmoothed()
    // Plötzlicher Target-Wechsel → Bias ändert sich graduell (SmoothDamp)

    [Test]
    public void Disabled_NoBias()
    // enabled = false → Yaw/Pitch unverändert

    [Test]
    public void ApplyPreset_SetsValues()
    // Preset anwenden → alle Felder korrekt übernommen
}
```

---

## Test-Pattern

### MockIntent

```csharp
private class MockIntent : ICameraIntent
{
    public int Priority { get; set; }
    public bool IsActive { get; set; } = true;
    private readonly System.Action<CameraState, CameraContext> _applyAction;

    public MockIntent(int priority, System.Action<CameraState, CameraContext> apply)
    {
        Priority = priority;
        _applyAction = apply;
    }

    public void Apply(ref CameraState state, CameraContext ctx)
    {
        _applyAction?.Invoke(state, ctx);
    }
}
```

### Test-Context erstellen

```csharp
private CameraContext CreateContext(
    Vector3? velocity = null,
    Vector3? forward = null,
    Transform lookTarget = null)
{
    return new CameraContext
    {
        AnchorPosition = Vector3.zero,
        CharacterVelocity = velocity ?? Vector3.zero,
        CharacterForward = forward ?? Vector3.forward,
        LookTarget = lookTarget,
        DeltaTime = 0.016f, // 60 FPS
        Input = default
    };
}
```

### Simulate-Methode für SmoothDamp-Tests

Da DynamicOrbitCenter und SoftTargeting SmoothDamp verwenden, konvergieren Werte nicht sofort. Tests die das Ergebnis nach Konvergenz prüfen:

```csharp
private void SimulateFrames(ICameraBehaviour behaviour, ref CameraState state,
    CameraContext ctx, int frames = 100)
{
    for (int i = 0; i < frames; i++)
        behaviour.UpdateState(ref state, ctx);
}
```

---

## Anweisungen

### Schritt 1: IntentResolutionTests erstellen

1. Erstelle `IntentResolutionTests.cs` in Camera.Core Tests
2. MockIntent-Klasse implementieren
3. Alle 7 Tests implementieren
4. Prioritäts-Sortierung und Additive-Stacking verifizieren

### Schritt 2: CameraPresetTests erstellen

1. Erstelle `CameraPresetTests.cs` in Camera.Core Tests
2. Preset-Erstellung und Default-Werte testen
3. ICameraPresetReceiver-Pattern testen

### Schritt 3: DynamicOrbitCenterTests erstellen

1. Erstelle `DynamicOrbitCenterTests.cs` in Camera.Behaviours Tests
2. Idle/Movement/Combat-Szenarien testen
3. Snap()-Methode testen
4. Preset-Anwendung testen

### Schritt 4: SoftTargetingTests erstellen

1. Erstelle `SoftTargetingTests.cs` in Camera.Behaviours Tests
2. Movement-Bias und Target-Bias testen
3. Range-Check und Clamping testen
4. SmoothDamp-Konvergenz testen

### Schritt 5: Alle Tests ausführen

```bash
# Unity Editor Logs auf Fehler prüfen:
powershell -Command "Get-Content 'C:\Users\marcu\AppData\Local\Unity\Editor\Editor.log' -Tail 100 | Select-String -Pattern 'error|CS\d{4}'"
```

Alle Tests müssen grün sein. Auch bestehende Camera.Core Tests müssen weiterhin funktionieren.

---

## Verifikations-Checkliste

- [ ] `IntentResolutionTests.cs` existiert mit allen 7 Tests
- [ ] `CameraPresetTests.cs` existiert mit allen 5 Tests
- [ ] `DynamicOrbitCenterTests.cs` existiert mit allen 8 Tests
- [ ] `SoftTargetingTests.cs` existiert mit allen 8 Tests
- [ ] Alle neuen Tests kompilieren
- [ ] Alle neuen Tests laufen grün
- [ ] Bestehende Camera.Core Tests laufen weiterhin grün
- [ ] Bestehende Camera.Behaviours Tests (aus Phase 27) laufen weiterhin grün
- [ ] Keine Compiler-Fehler im gesamten Projekt

---

## Erwartete Dateien nach diesem Schritt

```
Packages/Wiesenwischer.GameKit.Camera.Core/Tests/Runtime/
├── CameraStateTests.cs             (bestehend)
├── PivotRigTests.cs                (bestehend)
├── CameraAnchorTests.cs            (bestehend)
├── CameraInputPipelineTests.cs     (bestehend)
├── IntentResolutionTests.cs        (NEU)
└── CameraPresetTests.cs            (NEU)

Packages/Wiesenwischer.GameKit.Camera.Behaviours/Tests/Runtime/
├── OrbitBehaviourTests.cs           (Phase 27)
├── ZoomBehaviourTests.cs            (Phase 27)
├── CollisionBehaviourTests.cs       (Phase 27)
├── InertiaBehaviourTests.cs         (Phase 27)
├── RecenterBehaviourTests.cs        (Phase 27)
├── ShoulderOffsetBehaviourTests.cs  (Phase 27)
├── DynamicOrbitCenterTests.cs       (NEU)
└── SoftTargetingTests.cs            (NEU)
```

---

## Phase 28 abgeschlossen

Nach diesem Schritt ist Phase 28 komplett. Nächste Phase im Camera-Epic:

→ [Phase 29: Shared Orientation & Facing Integration](../phase-29-orientation-facing/README.md)
