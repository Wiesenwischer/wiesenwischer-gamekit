# 23.7 StateMachine + GroundedState Transition

> **Commit:** `feat(phase-23): 23.7 Crouch StateMachine-Integration`
> **Branch:** `feat/crouch-transitions`

---

## Ziel

`PlayerCrouchingState` in die StateMachine registrieren und den Crouch-Toggle-Check in `PlayerGroundedState` einbauen.

---

## Anweisungen

### 1. PlayerMovementStateMachine erweitern

**Datei:** `Packages/Wiesenwischer.GameKit.CharacterController.Core/Runtime/Core/StateMachine/PlayerMovementStateMachine.cs`

**Property hinzufügen:**
```csharp
public PlayerCrouchingState CrouchingState { get; }
```

**Im Konstruktor instanziieren:**
```csharp
CrouchingState = new PlayerCrouchingState(this);
```

### 2. PlayerGroundedState erweitern

**Datei:** `Packages/Wiesenwischer.GameKit.CharacterController.Core/Runtime/Core/StateMachine/States/PlayerGroundedState.cs`

In `OnHandleInput()` den Crouch-Toggle-Check hinzufügen:

```csharp
// Crouch Toggle (C-Taste)
if (ReusableData.CrouchTogglePressed)
{
    ChangeState(StateMachine.CrouchingState);
    return;
}
```

**Position:** Der Check sollte **nach** Sprint/Walk-Toggle-Checks stehen, damit Sprint Priorität über Crouch hat. Aber **vor** dem Jump-Check, damit C-Taste nicht von Jump überschrieben wird.

**Empfohlene Reihenfolge in HandleInput:**
1. Sprint-Check
2. Walk-Toggle-Check
3. **Crouch-Toggle-Check** ← NEU
4. Jump-Check
5. Dash-Check

### 3. Transition-Übersicht

| Von | Bedingung | Nach |
|-----|-----------|------|
| Idle/Walk/Run | C-Taste | CrouchingState |
| Sprinting | C-Taste | CrouchingState (bremst ab) |
| CrouchingState | C-Taste + CanStandUp | Idle/Walk/Run |
| CrouchingState | Sprint + CanStandUp | SprintingState |
| CrouchingState | Jump + CanJumpFromCrouch | JumpingState |
| CrouchingState | Kante | FallingState |
| CrouchingState | Steiler Hang | SlidingState |
| CrouchingState | C-Taste + !CanStandUp | CrouchingState (bleibt) |

### 4. Hinweis: Crouch-Persistenz

`ReusableData.IsCrouching` kann optional genutzt werden um Crouch über Sprünge hinweg zu persistieren. Für MVP ist dies nicht zwingend nötig — bei Jump wird automatisch aufgestanden.

---

## Verifikation

- [ ] `StateMachine.CrouchingState` Property existiert
- [ ] CrouchingState wird im Konstruktor instanziiert
- [ ] `PlayerGroundedState.OnHandleInput()` hat Crouch-Toggle-Check
- [ ] Aus Idle: C → Crouching
- [ ] Aus Walking: C → Crouching
- [ ] Aus Running: C → Crouching
- [ ] Aus Sprinting: C → Crouching
- [ ] Aus Crouching: C + CanStandUp → Idle/Walk/Run
- [ ] Kompilierung fehlerfrei

---

## Erwartete Dateien

```
Packages/.../Runtime/Core/StateMachine/PlayerMovementStateMachine.cs   (GEÄNDERT)
Packages/.../Runtime/Core/StateMachine/States/PlayerGroundedState.cs   (GEÄNDERT)
```

---

**Nächster Schritt:** [23.8 Unit Tests](23.8-unit-tests.md)
