# 23.5 Capsule-Höhen-Transition in CharacterLocomotion

> **Commit:** `feat(phase-23): 23.5 Capsule-Höhen-Transition`
> **Branch:** `feat/crouch-capsule`

---

## Ziel

`IsCrouching` Property und smooth Capsule-Höhen-Transition in `CharacterLocomotion` implementieren. Die Capsule-Höhe interpoliert bei Crouch-Ein/Austritt mittels `SmoothDamp`.

---

## Anweisungen

### 1. CharacterLocomotion erweitern

**Datei:** `Packages/Wiesenwischer.GameKit.CharacterController.Core/Runtime/Core/Locomotion/CharacterLocomotion.cs`

Neue Felder:

```csharp
private bool _isCrouching;
private bool _crouchTransitionActive;
private float _currentCapsuleHeight;
private float _targetCapsuleHeight;
private float _capsuleHeightVelocity; // für SmoothDamp
```

Neue Properties:

```csharp
/// <summary>Ob der Character aktuell im Crouch-State ist.</summary>
public bool IsCrouching => _isCrouching;
```

Neue Methoden:

```csharp
/// <summary>Setzt den Crouch-Status und startet die Capsule-Transition.</summary>
public void SetCrouching(bool crouching)
{
    _isCrouching = crouching;
    _targetCapsuleHeight = crouching ? _config.CrouchHeight : _config.StandingHeight;
    _crouchTransitionActive = true;
    _capsuleHeightVelocity = 0f; // SmoothDamp-Velocity resetten
}
```

### 2. Capsule-Transition Update

In einem geeigneten Update-Schritt (z.B. `AfterCharacterUpdate()` oder im regulären `Update()`):

```csharp
private void UpdateCapsuleTransition(float deltaTime)
{
    if (!_crouchTransitionActive) return;

    _currentCapsuleHeight = Mathf.SmoothDamp(
        _currentCapsuleHeight,
        _targetCapsuleHeight,
        ref _capsuleHeightVelocity,
        _config.CrouchTransitionDuration,
        Mathf.Infinity,
        deltaTime);

    float yOffset = _currentCapsuleHeight * 0.5f;
    Motor.SetCapsuleDimensions(Motor.Radius, _currentCapsuleHeight, yOffset);

    // Transition abschließen wenn nah genug am Ziel
    if (Mathf.Abs(_currentCapsuleHeight - _targetCapsuleHeight) < 0.01f)
    {
        Motor.SetCapsuleDimensions(Motor.Radius, _targetCapsuleHeight, _targetCapsuleHeight * 0.5f);
        _currentCapsuleHeight = _targetCapsuleHeight;
        _crouchTransitionActive = false;
    }
}
```

### 3. Initialisierung

Bei der Initialisierung von CharacterLocomotion:

```csharp
_currentCapsuleHeight = _config.StandingHeight;
_targetCapsuleHeight = _config.StandingHeight;
```

### 4. Stand-Up-Check (CanStandUp)

```csharp
/// <summary>Prüft ob genügend Platz zum Aufstehen vorhanden ist.</summary>
public bool CanStandUp()
{
    if (!_isCrouching) return true;

    float standingHeight = _config.StandingHeight;
    float currentHeight = Motor.Height;
    float heightDifference = standingHeight - currentHeight;
    float margin = _config.CrouchHeadClearanceMargin;

    // SphereCast nach oben vom Capsule-Top
    Vector3 origin = Motor.Transform.position + Motor.CharacterTransformToCapsuleTop;
    bool blocked = Physics.SphereCast(
        origin,
        Motor.Radius - 0.05f,
        Vector3.up,
        out _,
        heightDifference + margin,
        _config.GroundLayers);

    return !blocked;
}
```

### 5. Hinweise

- **YOffset-Berechnung:** `yOffset = height * 0.5f` hält die Capsule am Boden verankert (Center in der Mitte der Capsule)
- **Motor.SetCapsuleDimensions():** Aktualisiert automatisch alle Raycast-Origins für Ground Detection
- **SmoothDamp:** Gibt eine visuell angenehme Transition ohne abrupte Sprünge
- **GroundLayers:** Verwende die gleiche LayerMask wie für Ground Detection

---

## Verifikation

- [ ] `CharacterLocomotion.IsCrouching` Property existiert
- [ ] `SetCrouching(true)` → Capsule-Höhe interpoliert zu CrouchHeight
- [ ] `SetCrouching(false)` → Capsule-Höhe interpoliert zurück zu StandingHeight
- [ ] `CanStandUp()` gibt `false` zurück wenn Decke über Character
- [ ] Smooth Transition (kein Teleport der Höhe)
- [ ] Capsule bleibt am Boden verankert (keine Y-Verschiebung)
- [ ] Kompilierung fehlerfrei

---

## Erwartete Dateien

```
Packages/.../Runtime/Core/Locomotion/CharacterLocomotion.cs   (GEÄNDERT)
```

---

**Nächster Schritt:** [23.6 PlayerCrouchingState](23.6-crouching-state.md)
