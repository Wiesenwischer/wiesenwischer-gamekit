# 27.4 RecenterBehaviour + ShoulderOffsetBehaviour

> **Commit:** `feat(phase-27): 27.4 RecenterBehaviour + ShoulderOffsetBehaviour`

---

## Ziel

Zwei Behaviours für AAA-Feeling:
- **RecenterBehaviour** — Auto-Recenter: Kamera dreht sich langsam hinter den Character wenn keine Look-Eingabe kommt
- **ShoulderOffsetBehaviour** — Over-Shoulder-Ansicht mit Side-Switch

---

## 1. RecenterBehaviour

**`Runtime/RecenterBehaviour.cs`**

BDO-typisches Feature: Wenn der Spieler sich bewegt aber nicht die Kamera dreht, zentriert sich die Kamera langsam hinter dem Character.

```csharp
namespace Wiesenwischer.GameKit.Camera.Behaviours
{
    /// <summary>
    /// Auto-Recenter: Kamera dreht sich hinter den Character
    /// wenn keine Look-Eingabe vorliegt und der Character sich bewegt.
    /// </summary>
    public class RecenterBehaviour : MonoBehaviour, ICameraBehaviour
    {
        [Header("Recenter")]
        [Tooltip("Verzögerung bevor Recenter startet (Sekunden nach letztem Look-Input).")]
        [SerializeField] private float _delay = 1.5f;

        [Tooltip("Recenter-Geschwindigkeit (Grad/Sekunde).")]
        [SerializeField] private float _speed = 60f;

        [Tooltip("Minimale Movement-Geschwindigkeit für Recenter-Aktivierung.")]
        [SerializeField] private float _minMoveSpeed = 0.5f;

        // Runtime
        private float _timeSinceLastInput;
        private Vector3 _lastTargetPosition;

        public bool IsActive => enabled;

        public void UpdateState(ref CameraState state, CameraContext ctx)
        {
            // Input-Erkennung: Reset Timer bei Look-Input
            bool hasLookInput = Mathf.Abs(ctx.Input.LookX) > 0.01f
                             || Mathf.Abs(ctx.Input.LookY) > 0.01f;

            if (hasLookInput)
            {
                _timeSinceLastInput = 0f;
                return;
            }

            _timeSinceLastInput += ctx.DeltaTime;

            // Delay abwarten
            if (_timeSinceLastInput < _delay) return;

            // Movement-Richtung ermitteln
            if (ctx.FollowTarget == null) return;

            Vector3 currentPos = ctx.FollowTarget.position;
            Vector3 moveDir = currentPos - _lastTargetPosition;
            _lastTargetPosition = currentPos;

            moveDir.y = 0f;
            if (moveDir.magnitude < _minMoveSpeed * ctx.DeltaTime) return;

            // Ziel-Yaw aus Bewegungsrichtung
            float targetYaw = Mathf.Atan2(moveDir.x, moveDir.z) * Mathf.Rad2Deg;

            // Sanftes Drehen zum Ziel-Yaw
            float yawDiff = Mathf.DeltaAngle(state.Yaw, targetYaw);
            float maxStep = _speed * ctx.DeltaTime;
            state.Yaw += Mathf.Clamp(yawDiff, -maxStep, maxStep);
        }
    }
}
```

---

## 2. ShoulderOffsetBehaviour

**`Runtime/ShoulderOffsetBehaviour.cs`**

Statischer seitlicher Versatz für Over-the-Shoulder-Ansicht. Unterstützt Side-Switch (Links/Rechts-Schulter wechseln).

```csharp
namespace Wiesenwischer.GameKit.Camera.Behaviours
{
    /// <summary>
    /// Shoulder-Offset: Seitlicher Versatz für Over-the-Shoulder-Ansicht.
    /// </summary>
    public class ShoulderOffsetBehaviour : MonoBehaviour, ICameraBehaviour
    {
        [Header("Offset")]
        [Tooltip("Seitlicher Versatz (positiv = rechte Schulter).")]
        [SerializeField] private float _offsetX = 0.5f;

        [Tooltip("Vertikaler Versatz.")]
        [SerializeField] private float _offsetY = 0f;

        [Header("Side Switch")]
        [Tooltip("SmoothDamp-Zeit beim Seite-Wechseln.")]
        [SerializeField] private float _switchDamping = 0.2f;

        private float _currentOffsetX;
        private float _switchVelocity;
        private bool _rightShoulder = true;

        public bool IsActive => enabled;

        /// <summary>Wechselt die Schulterseite.</summary>
        public void SwitchSide()
        {
            _rightShoulder = !_rightShoulder;
        }

        /// <summary>Aktuelle Seite: true = rechts, false = links.</summary>
        public bool IsRightShoulder => _rightShoulder;

        public void UpdateState(ref CameraState state, CameraContext ctx)
        {
            float targetX = _rightShoulder ? _offsetX : -_offsetX;

            _currentOffsetX = Mathf.SmoothDamp(
                _currentOffsetX, targetX, ref _switchVelocity,
                _switchDamping, Mathf.Infinity, ctx.DeltaTime);

            state.ShoulderOffset = new Vector3(_currentOffsetX, _offsetY, 0f);
        }
    }
}
```

---

## Akzeptanzkriterien

### RecenterBehaviour
- [ ] Kamera recentert hinter Character-Bewegungsrichtung
- [ ] Recenter startet erst nach Delay (kein Input)
- [ ] Recenter nur bei Bewegung (nicht im Idle)
- [ ] Look-Input unterbricht sofort

### ShoulderOffsetBehaviour
- [ ] ShoulderOffset wird korrekt gesetzt
- [ ] SwitchSide() wechselt Links/Rechts
- [ ] Smooth Transition beim Seitenwechsel
