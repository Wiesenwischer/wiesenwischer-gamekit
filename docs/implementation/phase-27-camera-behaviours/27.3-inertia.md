# 27.3 InertiaBehaviour

> **Commit:** `feat(phase-27): 27.3 InertiaBehaviour`

---

## Ziel

Physik-inspiriertes **Spring-Damper-System** für cinematic Camera-Feeling. Statt starrer Verfolgung (Lerp) erzeugt die Inertia ein Gewicht-/Masse-Gefühl mit Overshooting bei schnellen Bewegungen.

---

## Konzept (Spec Kapitel 12)

```csharp
velocity += (target - current) * stiffness;
velocity *= damping;
position += velocity * deltaTime;
```

**Ergebnis:**
- Kamera schwingt leicht nach bei schnellen Character-Bewegungen
- Gewicht/Masse-Gefühl wie in AAA-Titeln (BDO, Elden Ring)
- Konfigurierbar von "eng/responsive" bis "cinematic/schwer"

---

## Implementierung

**`Runtime/InertiaBehaviour.cs`**

InertiaBehaviour modifiziert **nicht** den CameraState direkt — es modifiziert die **AnchorPosition** im CameraContext. Das erzeugt einen Positions-Lag auf dem gesamten Camera-Rig.

**Wichtig:** InertiaBehaviour muss eine eigene Velocity tracken und die AnchorPosition im Context manipulieren. Da `UpdateState` nur `ref CameraState` modifiziert, verwenden wir einen alternativen Ansatz: Der CameraBrain ruft `InertiaBehaviour.ModifyAnchor()` separat auf, oder wir speichern den Offset als internen State und addieren ihn in UpdateState.

**Pragmatischer Ansatz:** InertiaBehaviour trackt intern eine geglättete Position und überschreibt `ctx.AnchorPosition` direkt (CameraContext ist eine Klasse, kein Struct — Modifikation möglich).

```csharp
namespace Wiesenwischer.GameKit.Camera.Behaviours
{
    /// <summary>
    /// Inertia-Verhalten: Spring-Damper-System für cinematic Camera-Lag.
    /// Glättet die Anchor-Position mit physik-inspiriertem Nachschwingen.
    /// </summary>
    public class InertiaBehaviour : MonoBehaviour, ICameraBehaviour
    {
        [Header("Spring-Damper")]
        [Tooltip("Stiffness der Feder. Höher = enger am Target.")]
        [SerializeField] private float _stiffness = 15f;

        [Tooltip("Dämpfung. 0-1. Niedrig = mehr Overshooting.")]
        [SerializeField] private float _damping = 0.85f;

        [Header("Limits")]
        [Tooltip("Maximaler Offset vom Target (verhindert extremes Nachhinken).")]
        [SerializeField] private float _maxOffset = 1.5f;

        private Vector3 _velocity;
        private Vector3 _currentPosition;
        private bool _initialized;

        public bool IsActive => enabled;

        public void UpdateState(ref CameraState state, CameraContext ctx)
        {
            if (!_initialized)
            {
                _currentPosition = ctx.AnchorPosition;
                _initialized = true;
                return;
            }

            Vector3 target = ctx.AnchorPosition;
            float dt = ctx.DeltaTime;

            // Spring-Damper
            _velocity += (target - _currentPosition) * _stiffness * dt;
            _velocity *= Mathf.Pow(_damping, dt * 60f); // Frame-rate independent damping

            _currentPosition += _velocity * dt;

            // Max-Offset clamp
            Vector3 offset = _currentPosition - target;
            if (offset.magnitude > _maxOffset)
                _currentPosition = target + offset.normalized * _maxOffset;

            // AnchorPosition im Context überschreiben (Klasse = Referenz)
            ctx.AnchorPosition = _currentPosition;
        }

        /// <summary>Sofort zur Zielposition teleportieren (kein Lag).</summary>
        public void Snap(Vector3 position)
        {
            _currentPosition = position;
            _velocity = Vector3.zero;
            _initialized = true;
        }
    }
}
```

---

## Konfiguration

| Parameter | Default | Erklärung |
|-----------|---------|-----------|
| `_stiffness` | 15 | Höher = Kamera folgt enger |
| `_damping` | 0.85 | Niedriger = mehr Overshooting |
| `_maxOffset` | 1.5m | Verhindert extremes Abfallen bei schnellen Teleports |

**Presets (Empfehlung für Phase 28):**
- BDO-Style: Stiffness=12, Damping=0.8 (cinematic, schwer)
- ArcheAge-Style: Stiffness=25, Damping=0.95 (eng, responsive)

---

## Akzeptanzkriterien

- [ ] Kamera schwingt leicht nach bei schnellen Richtungswechseln
- [ ] Kein Nachschwingen im Idle (Kamera ruht stabil)
- [ ] Snap() teleportiert sofort (kein Lag)
- [ ] MaxOffset verhindert extremes Nachhinken
- [ ] Frame-rate-unabhängiges Damping
