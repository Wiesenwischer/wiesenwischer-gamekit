# 27.5 CameraBrain Refactor + Editor Update

> **Commit:** `feat(phase-27): 27.5 CameraBrain Refactor + Editor Update`

---

## Ziel

1. **CameraBrain** refactoren: Eingebettete Orbit/Zoom/Collision-Logik entfernen, nur noch ICameraBehaviour[] verwenden
2. **CameraCoreConfig** vereinfachen: Behaviour-spezifische Felder entfernen (sind jetzt auf den Behaviours)
3. **CameraSetupEditor** aktualisieren: Standard-Behaviours beim Setup hinzufügen

---

## 1. CameraBrain Refactor

### Entfernen
- `UpdateOrbit()` — ersetzt durch OrbitBehaviour
- `UpdateZoom()` — ersetzt durch ZoomBehaviour
- `CheckCollision()` — ersetzt durch CollisionBehaviour
- `_zoomVelocity` Feld

### Ändern: Behaviour-Discovery

Statt `[SerializeField] private MonoBehaviour[] _behaviourComponents` → automatische Discovery:

```csharp
private ICameraBehaviour[] _behaviours;

private void Awake()
{
    _rig = GetComponent<PivotRig>();
    _rig.EnsureHierarchy();

    _context = new CameraContext();
    _state = CameraState.Default;

    // Auto-discover Behaviours auf diesem GameObject
    _behaviours = GetComponents<ICameraBehaviour>();

    if (_camera == null)
        _camera = GetComponentInChildren<UnityEngine.Camera>();
}
```

### Ändern: LateUpdate vereinfacht

```csharp
private void LateUpdate()
{
    float dt = Time.deltaTime;

    // 1. Input
    CameraInputState input = default;
    if (_inputPipeline != null)
        input = _inputPipeline.ProcessInput(dt);

    // 2. Anchor
    if (_anchor != null)
        _anchor.UpdateAnchor(dt);

    // 3. Context
    _context.Input = input;
    _context.AnchorPosition = _anchor != null ? _anchor.AnchorPosition : transform.position;
    _context.DeltaTime = dt;

    // 4. Behaviours evaluieren
    foreach (var behaviour in _behaviours)
    {
        if (behaviour.IsActive)
            behaviour.UpdateState(ref _state, _context);
    }

    // 5. Apply
    _rig.ApplyState(_state, _context.AnchorPosition);

    // 6. FOV
    if (_camera != null)
        _camera.fieldOfView = _state.Fov;
}
```

### Public API erweitern

```csharp
/// <summary>Behaviour-Liste neu einlesen (z.B. nach AddComponent).</summary>
public void RefreshBehaviours()
{
    _behaviours = GetComponents<ICameraBehaviour>();
}
```

---

## 2. CameraCoreConfig vereinfachen

Felder die jetzt auf den Behaviours liegen, aus CameraCoreConfig **entfernen**:

| Feld | Jetzt auf |
|------|-----------|
| `MinVerticalAngle` / `MaxVerticalAngle` | OrbitBehaviour |
| `MinDistance` / `MaxDistance` | ZoomBehaviour |
| `DefaultDistance` | ZoomBehaviour |
| `ZoomDamping` | ZoomBehaviour |
| `CollisionRadius` | CollisionBehaviour |

**CameraCoreConfig wird leer** — die Klasse bleibt bestehen als Platzhalter für Phase-28-Felder (z.B. CameraPreset-Referenz). Alternativ kann sie vorerst entfernt werden.

**Empfehlung:** CameraCoreConfig behalten mit minimalen globalen Feldern:
```csharp
public class CameraCoreConfig : ScriptableObject
{
    [Header("Global")]
    [Tooltip("Standard-FOV")]
    public float DefaultFov = 60f;
}
```

---

## 3. CameraSetupEditor aktualisieren

Das Editor-Menü `Setup Camera Brain` muss nach dem CameraBrain-Setup die Standard-Behaviours hinzufügen:

```csharp
// Standard-Behaviours hinzufügen
AddBehaviourIfMissing<OrbitBehaviour>(cameraRoot);
AddBehaviourIfMissing<ZoomBehaviour>(cameraRoot);
AddBehaviourIfMissing<CollisionBehaviour>(cameraRoot);
// Optional:
// AddBehaviourIfMissing<InertiaBehaviour>(cameraRoot);
// AddBehaviourIfMissing<RecenterBehaviour>(cameraRoot);
// AddBehaviourIfMissing<ShoulderOffsetBehaviour>(cameraRoot);
```

**Hinweis:** Die Editor-Assembly braucht eine neue Referenz zu `Wiesenwischer.GameKit.Camera.Behaviours.Runtime`.

---

## 4. SnapBehindTarget aktualisieren

`SnapBehindTarget()` muss auch die InertiaBehaviour-Position snappen:

```csharp
public void SnapBehindTarget()
{
    if (_anchor != null && _anchor.FollowTarget != null)
    {
        _anchor.SnapToTarget();
        _state.Yaw = _anchor.FollowTarget.eulerAngles.y;
        _state.Pitch = 0f;

        // Inertia snappen falls vorhanden
        var inertia = GetComponent<InertiaBehaviour>();
        if (inertia != null)
            inertia.Snap(_anchor.AnchorPosition);

        _rig.ApplyState(_state, _anchor.AnchorPosition);
    }
}
```

---

## Akzeptanzkriterien

- [ ] CameraBrain enthält keine eigene Orbit/Zoom/Collision-Logik mehr
- [ ] Behaviours werden per GetComponents<ICameraBehaviour>() entdeckt
- [ ] Behaviour-Reihenfolge entspricht Komponenten-Reihenfolge im Inspector
- [ ] CameraSetupEditor fügt Standard-Behaviours hinzu
- [ ] SnapBehindTarget() funktioniert mit InertiaBehaviour
- [ ] Kamera verhält sich nach Refactor identisch zu vorher
- [ ] Alte CameraCoreConfig-Felder entfernt (jetzt auf Behaviours)
