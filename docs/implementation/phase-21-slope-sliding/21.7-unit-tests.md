# 21.7 Unit Tests

> **Commit:** `test(phase-21): 21.7 Sliding Unit Tests`
> **Branch:** `test/slide-tests`

---

## Ziel

Unit Tests für den Sliding-State, die Config-Erweiterung und die Transition-Logik.

---

## Anweisungen

### 1. Test-Datei erstellen

**Datei:** `Packages/Wiesenwischer.GameKit.CharacterController.Core/Tests/Runtime/SlidingStateTests.cs`

### 2. Tests implementieren

```csharp
using NUnit.Framework;
using UnityEngine;

namespace Wiesenwischer.GameKit.CharacterController.Core.Tests
{
    [TestFixture]
    public class SlidingStateTests
    {
        // --- Entry-Bedingungen ---

        [Test]
        public void SlidingState_EntersWhenSlopeExceedsMaxAngle()
        {
            // Arrange: SlopeAngle > MaxSlopeAngle + FoundAnyGround
            // Act: GroundedState.OnUpdate()
            // Assert: State wechselt zu SlidingState
        }

        [Test]
        public void SlidingState_DoesNotEnterOnWalkableSlope()
        {
            // Arrange: SlopeAngle <= MaxSlopeAngle
            // Act: GroundedState.OnUpdate()
            // Assert: State bleibt Grounded
        }

        [Test]
        public void SlidingState_EntersFromFalling_WhenLandingOnSteepSlope()
        {
            // Arrange: FallingState + Landing auf SlopeAngle > MaxSlopeAngle
            // Act: FallingState Landing-Logik
            // Assert: State wechselt zu SlidingState (nicht SoftLand/HardLand)
        }

        // --- Exit-Bedingungen ---

        [Test]
        public void SlidingState_ExitsWhenSlopeBecomesWalkable()
        {
            // Arrange: Im SlidingState, SlopeAngle sinkt unter (MaxSlopeAngle - Hysteresis)
            // Act: SlidingState.OnUpdate()
            // Assert: State wechselt zu Grounded (Idle/Moving)
        }

        [Test]
        public void SlidingState_ExitsToFallingWhenGroundLost()
        {
            // Arrange: Im SlidingState, FoundAnyGround wird false
            // Act: SlidingState.OnUpdate()
            // Assert: State wechselt zu FallingState
        }

        [Test]
        public void SlidingState_RespectsHysteresis()
        {
            // Arrange: SlopeAngle = MaxSlopeAngle - 1° (innerhalb Hysteresis)
            // Act: SlidingState.OnUpdate()
            // Assert: State bleibt Sliding (Hysteresis-Puffer)
        }

        [Test]
        public void SlidingState_RespectsMinSlideTime()
        {
            // Arrange: Gerade in SlidingState eingetreten, SlopeAngle < ExitAngle
            // Act: SlidingState.OnUpdate() sofort nach Enter
            // Assert: State bleibt Sliding (MinSlideTime noch nicht abgelaufen)
        }

        // --- Physik ---

        [Test]
        public void SlidingState_SpeedScalesWithSlopeAngle()
        {
            // Arrange: UseSlopeDependentSlideSpeed = true
            // Act: CalculateSlideVelocity mit 50° vs 80°
            // Assert: 80° hat höhere Geschwindigkeit
        }

        [Test]
        public void SlidingState_SteerInputAffectsDirection()
        {
            // Arrange: Im SlidingState, SlideSteerStrength > 0, Movement-Input seitlich
            // Act: PhysicsUpdate
            // Assert: Velocity hat seitliche Komponente
        }

        // --- Jump ---

        [Test]
        public void SlidingState_JumpFromSlide_WhenEnabled()
        {
            // Arrange: CanJumpFromSlide = true, Jump-Input
            // Act: SlidingState.OnHandleInput()
            // Assert: State wechselt zu JumpingState
        }

        [Test]
        public void SlidingState_NoJump_WhenDisabled()
        {
            // Arrange: CanJumpFromSlide = false, Jump-Input
            // Act: SlidingState.OnHandleInput()
            // Assert: State bleibt Sliding
        }

        // --- Config ---

        [Test]
        public void Config_NewSlidingParametersHaveCorrectDefaults()
        {
            // Assert: SlideAcceleration = 15, SlideSteerStrength = 0.3, etc.
        }

        // --- Intent-System ---

        [Test]
        public void SlidingState_SetsIsSliding_OnEnter()
        {
            // Act: SlidingState.Enter()
            // Assert: Locomotion.IsSliding == true
        }

        [Test]
        public void SlidingState_ClearsIsSliding_OnExit()
        {
            // Arrange: Im SlidingState
            // Act: SlidingState.Exit()
            // Assert: Locomotion.IsSliding == false
        }
    }
}
```

### 3. Bestehende SlopeModule Tests erweitern

**Datei:** `Packages/.../Tests/Runtime/SlopeModuleTests.cs` (falls vorhanden)

Prüfen ob `CalculateSlideVelocity` bereits getestet wird. Falls nicht:

```csharp
[Test]
public void CalculateSlideVelocity_ReturnsDownhillDirection()
{
    var module = new SlopeModule();
    var normal = new Vector3(0.5f, 0.866f, 0f).normalized; // ~30° Slope
    var velocity = module.CalculateSlideVelocity(normal, 10f, 30f);

    Assert.That(velocity.y, Is.LessThan(0f)); // Abwärts
    Assert.That(velocity.magnitude, Is.GreaterThan(0f)); // Nicht null
}

[Test]
public void CalculateSlideVelocity_SteeperSlopeIsFaster()
{
    var module = new SlopeModule();
    var normal30 = Quaternion.Euler(30f, 0f, 0f) * Vector3.up;
    var normal60 = Quaternion.Euler(60f, 0f, 0f) * Vector3.up;

    var v30 = module.CalculateSlideVelocity(normal30, 10f, 30f);
    var v60 = module.CalculateSlideVelocity(normal60, 10f, 60f);

    Assert.That(v60.magnitude, Is.GreaterThan(v30.magnitude));
}
```

### 4. Kompilierung + Tests ausführen

```bash
powershell -Command "Get-Content 'C:\Users\marcu\AppData\Local\Unity\Editor\Editor.log' -Tail 100 | Select-String -Pattern 'error|CS\d{4}'"
```

---

## Verifikation

- [ ] Alle Unit Tests kompilieren
- [ ] Alle Entry/Exit-Tests bestehen
- [ ] Physik-Tests (Speed-Skalierung, Lenkung) bestehen
- [ ] Config-Default-Tests bestehen
- [ ] Intent-System Tests (IsSliding) bestehen
- [ ] Bestehende Tests laufen weiterhin grün

---

## Erwartete Dateien

```
A  Packages/.../Tests/Runtime/SlidingStateTests.cs      (Neue Tests)
M  Packages/.../Tests/Runtime/SlopeModuleTests.cs        (Erweiterte Tests, falls vorhanden)
```

---

**Nächster Schritt:** [21.8 Play Mode Verifikation](21.8-play-mode-verifikation.md)
