# 25.2 FootIK Koordination

> **Commit-Message:** `feat(phase-25): 25.2 FootIK prüft FootLock-Flags`
> **Branch:** `feat/footlock-module` (gleicher Branch wie 25.1)

---

## Ziel

FootIK so erweitern, dass es gelockte Füße nicht überschreibt. Wenn FootLock einen Fuß kontrolliert, soll FootIK diesen Fuß komplett überspringen.

## Datei

`Packages/Wiesenwischer.GameKit.CharacterController.IK/Runtime/Modules/FootIK.cs`

## Änderungen

### FootLock-Referenz cachen

In `ProcessIK`, FootLock-Modul vom IKManager holen:

```csharp
public void ProcessIK(Animator animator, int layerIndex)
{
    if (layerIndex != 0) return;

    // FootLock-Referenz (einmalig pro Frame)
    var footLock = _ikManager.GetModule<FootLock>();
    bool leftLocked = footLock != null && footLock.IsLeftFootLocked;
    bool rightLocked = footLock != null && footLock.IsRightFootLocked;

    // ... existing weight calculation ...

    // Left Foot — nur wenn NICHT gelockt
    if (_leftFootHit && !leftLocked)
    {
        // ... existing left foot IK code ...
    }
    else if (!leftLocked)
    {
        animator.SetIKPositionWeight(AvatarIKGoal.LeftFoot, 0f);
        animator.SetIKRotationWeight(AvatarIKGoal.LeftFoot, 0f);
    }
    // Wenn leftLocked: NICHTS tun — FootLock kontrolliert den Fuß

    // Right Foot — nur wenn NICHT gelockt
    if (_rightFootHit && !rightLocked)
    {
        // ... existing right foot IK code ...
    }
    else if (!rightLocked)
    {
        animator.SetIKPositionWeight(AvatarIKGoal.RightFoot, 0f);
        animator.SetIKRotationWeight(AvatarIKGoal.RightFoot, 0f);
    }
    // Wenn rightLocked: NICHTS tun — FootLock kontrolliert den Fuß
}
```

### Wichtig: Body-Offset bei gelockten Füßen

In `PrepareIK`, den Body-Offset-Berechnung anpassen:
- Wenn ein Fuß gelockt ist, soll sein Delta NICHT in den Body-Offset einfließen
- Grund: Der gelockte Fuß wird per IK an eine feste Position gesetzt, sein animierter Delta ist irrelevant

```csharp
// In PrepareIK, Body Offset Berechnung:
float targetBodyOffset = 0f;
bool useLeft = _leftFootHit && !(footLock != null && footLock.IsLeftFootLocked);
bool useRight = _rightFootHit && !(footLock != null && footLock.IsRightFootLocked);

if (useLeft && useRight)
{
    float leftDelta = _leftFootTarget.y - leftFoot.y;
    float rightDelta = _rightFootTarget.y - rightFoot.y;
    targetBodyOffset = Mathf.Min(leftDelta, rightDelta);
}
else if (useLeft)
{
    targetBodyOffset = _leftFootTarget.y - leftFoot.y;
}
else if (useRight)
{
    targetBodyOffset = _rightFootTarget.y - rightFoot.y;
}
// Wenn beide gelockt: targetBodyOffset bleibt 0 (kein Terrain-IK nötig)

targetBodyOffset = Mathf.Clamp(targetBodyOffset, -_maxFootAdjustment, _maxBodyUpOffset);
```

### Minimaler Ansatz

Die Änderungen sind gezielt:
1. **ProcessIK:** Zwei `bool`-Flags + `if`-Checks um bestehende Blöcke
2. **PrepareIK (Body-Offset):** FootLock-Referenz prüfen, gelockte Füße ausschließen

Keine strukturellen Änderungen an FootIK.

## Verifikation

- [ ] FootIK kompiliert fehlerfrei
- [ ] Wenn FootLock aktiv: Gelockte Füße werden von FootIK nicht angefasst
- [ ] Wenn FootLock inaktiv/nicht vorhanden: FootIK funktioniert wie bisher (null-safe)
- [ ] Body-Offset berechnet sich korrekt mit/ohne gelockte Füße
- [ ] Bestehende FootIK-Tests laufen weiterhin grün

## Erwartete Dateien

```
Packages/Wiesenwischer.GameKit.CharacterController.IK/
└── Runtime/Modules/FootIK.cs  (MODIFIZIERT)
```

---

**Nächster Schritt:** [25.3 IKSetupWizard Erweiterung](25.3-wizard-extension.md)
