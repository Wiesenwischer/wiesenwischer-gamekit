# 25.4 Unit Tests

> **Commit-Message:** `test(phase-25): 25.4 FootLock Unit Tests`
> **Branch:** `test/footlock-tests`

---

## Ziel

Unit Tests für die FootLock Kern-Logik. Testet die `CalculateFootLock` Pure Function ohne MonoBehaviour-Abhängigkeiten.

## Datei

`Packages/Wiesenwischer.GameKit.CharacterController.IK/Tests/Runtime/FootLockTests.cs`

## Test-Cases

### 1. Lock-Erkennung

**`FootLock_VelocityBelowThreshold_LocksAfterStableFrames`**
- Fuß-Position ändert sich minimal (unter Lock-Threshold)
- Nach `_stableFramesRequired` Frames → `IsLocked = true`
- Gelockte Position in Local-Space gespeichert

**`FootLock_VelocityBelowThreshold_NotLockedBeforeStableFrames`**
- Fuß steht still, aber erst 1 Frame (bei `_stableFramesRequired = 2`)
- `IsLocked` bleibt `false`

**`FootLock_NotGrounded_NeverLocks`**
- Fuß steht still, aber `isGrounded = false`
- `IsLocked` bleibt `false`, `StableCount` bleibt 0

### 2. Release-Erkennung

**`FootLock_VelocityAboveReleaseThreshold_ReleasesLock`**
- Fuß ist gelockt
- Velocity steigt über Release-Threshold
- `IsLocked = false`, `IsReleasing = true`

**`FootLock_VelocityBetweenThresholds_StaysLocked`**
- Fuß ist gelockt
- Velocity zwischen Lock-Threshold und Release-Threshold (Hysterese-Bereich)
- `IsLocked` bleibt `true`

### 3. Release Blend

**`FootLock_ReleaseBlend_TimerAdvances`**
- `IsReleasing = true`
- Nach deltaTime: `ReleaseTimer` um deltaTime erhöht
- Weight = `1 - timer/duration`

**`FootLock_ReleaseBlend_CompletesAfterDuration`**
- `IsReleasing = true`, Timer läuft bis `_releaseDuration`
- Danach: `IsReleasing = false`

### 4. Local-Space

**`FootLock_LocalSpaceStorage_SurvivesCharacterRotation`**
- Fuß bei Position (1, 0, 0) locken
- Root-Transform um 90° drehen
- Gelockte Welt-Position berechnen → muss mitdrehen

**`FootLock_LocalSpaceStorage_SurvivesCharacterMovement`**
- Fuß locken
- Root-Transform verschieben
- Gelockte Welt-Position berechnen → muss mitwandern

### 5. Sicherheitsmechanismen

**`FootLock_MaxLockDistance_ForcesRelease`**
- Fuß ist gelockt
- Animierte Position weicht um > `_maxLockDistance` ab
- Lock wird gelöst, Release-Blend startet

**`FootLock_MaxLockDistance_WithinLimit_StaysLocked`**
- Fuß ist gelockt
- Animierte Position weicht um weniger als `_maxLockDistance` ab
- Lock bleibt bestehen

### 6. IK-Weight Berechnung

**`FootLock_ProcessWeight_LockedFull`**
- Fuß gelockt → Weight = `_weight` (1.0)

**`FootLock_ProcessWeight_ReleasingDecays`**
- Fuß releasing, Timer bei 50% der Duration
- Weight = `_weight * 0.5`

**`FootLock_ProcessWeight_NotLockedNotReleasing_Zero`**
- Weder gelockt noch releasing
- Kein IK angewendet (Weight = 0 / Methode macht nichts)

## Implementierung

```csharp
using NUnit.Framework;
using UnityEngine;
using Wiesenwischer.GameKit.CharacterController.IK.Modules;

namespace Wiesenwischer.GameKit.CharacterController.IK.Tests
{
    [TestFixture]
    public class FootLockTests
    {
        private const float LockThreshold = 0.05f;
        private const float ReleaseThreshold = 0.15f;
        private const int StableFrames = 2;
        private const float ReleaseDuration = 0.15f;
        private const float MaxLockDistance = 0.3f;
        private const float DeltaTime = 0.016f; // ~60fps

        // Helper: FootState mit stationärem Fuß erstellen
        private FootLock.FootState CreateStationaryState(Vector3 pos)
        {
            return new FootLock.FootState { PrevWorldPos = pos };
        }

        // Tests nutzen FootLock.CalculateFootLock(...)
    }
}
```

## Verifikation

- [ ] Alle Tests kompilieren fehlerfrei
- [ ] Alle Tests laufen grün
- [ ] Mindestens 12 Test-Cases abgedeckt
- [ ] Keine MonoBehaviour-Abhängigkeiten in Tests (Pure Functions)

## Erwartete Dateien

```
Packages/Wiesenwischer.GameKit.CharacterController.IK/
└── Tests/Runtime/FootLockTests.cs  (NEU)
```

---

**Nächster Schritt:** [25.5 Play Mode Verifikation](25.5-play-mode-verifikation.md)
