# 6.2 Network Abstractions in Core

**Commit:** `feat(phase-6): 6.2 Network Abstractions in Core`
**Branch:** `feat/network-abstractions`

---

## Ziel

Netzwerk-relevante Interfaces in `CharacterController.Core` ergänzen, damit PlayerController und andere Core-Klassen auf Netzwerk-Rollen zugreifen können — **ohne** FishNet-Abhängigkeit.

---

## Anweisungen

### 1. INetworkRole Interface

Neues Interface in `CharacterController.Core/Runtime/Core/Network/INetworkRole.cs`:

```csharp
namespace Wiesenwischer.GameKit.CharacterController.Core
{
    /// <summary>
    /// Abstraktion der Netzwerk-Rolle eines Objekts.
    /// Implementiert vom Network-Package (z.B. FishNet).
    /// Im Offline-Modus liefert eine Default-Implementierung alles als "lokal".
    /// </summary>
    public interface INetworkRole
    {
        /// <summary>Ist dies der lokale Spieler (hat Input-Authority)?</summary>
        bool IsOwner { get; }

        /// <summary>Läuft dieser Code auf dem Server?</summary>
        bool IsServer { get; }

        /// <summary>Läuft dieser Code auf einem Client?</summary>
        bool IsClient { get; }

        /// <summary>Ist das Netzwerk aktiv (Multiplayer-Modus)?</summary>
        bool IsNetworkActive { get; }
    }
}
```

### 2. OfflineNetworkRole (Default-Implementierung)

Neues Klasse in `CharacterController.Core/Runtime/Core/Network/OfflineNetworkRole.cs`:

```csharp
namespace Wiesenwischer.GameKit.CharacterController.Core
{
    /// <summary>
    /// Default-Implementierung für Offline/Singleplayer.
    /// Gibt immer Owner=true, Server=false, NetworkActive=false zurück.
    /// </summary>
    public sealed class OfflineNetworkRole : INetworkRole
    {
        public static readonly OfflineNetworkRole Instance = new();

        public bool IsOwner => true;
        public bool IsServer => false;
        public bool IsClient => true;
        public bool IsNetworkActive => false;
    }
}
```

### 3. INetworkTickProvider Interface

Neues Interface in `CharacterController.Core/Runtime/Core/Network/INetworkTickProvider.cs`:

```csharp
namespace Wiesenwischer.GameKit.CharacterController.Core
{
    /// <summary>
    /// Synchronisiert Tick-Zähler zwischen Server und Client.
    /// Im Offline-Modus verwendet der lokale TickSystem den eigenen Tick.
    /// Im Netzwerk liefert der Server den autoritativen Tick.
    /// </summary>
    public interface INetworkTickProvider
    {
        /// <summary>Der aktuelle Server-Tick (oder lokaler Tick im Offline-Modus).</summary>
        int ServerTick { get; }

        /// <summary>Geschätzte Round-Trip-Time in Sekunden.</summary>
        float EstimatedRtt { get; }

        /// <summary>Differenz zwischen lokalem und Server-Tick.</summary>
        int TickOffset { get; }
    }
}
```

### 4. PlayerController erweitern

`PlayerController.cs` um `INetworkRole`-Property ergänzen:

```csharp
// In PlayerController:
public INetworkRole NetworkRole { get; private set; }

// In InitializeComponents():
NetworkRole = GetComponent<INetworkRole>() ?? OfflineNetworkRole.Instance;
```

Damit kann PlayerController netzwerk-aware Code ausführen (z.B. Input nur bei `NetworkRole.IsOwner` lesen), ohne FishNet zu kennen.

### 5. Bestehende Interfaces prüfen

Prüfe ob `IPredictionSystem` und `IPredictable` für Phase 6 ausreichen:

**IPredictionSystem** — bereits vorhanden, enthält:
- `RecordInput()`, `RecordState()` — Aufzeichnung
- `OnServerStateReceived()` — Server-State empfangen
- `Reconcile()` — Rollback + Re-Simulation
- `Cleanup()` — History bereinigen

**IPredictable** — bereits vorhanden, enthält:
- `CreateStateSnapshot()` — State aufnehmen
- `ApplyState()` — State wiederherstellen
- `SimulateTick()` — Einen Tick simulieren

→ Beide Interfaces sind ausreichend. Keine Änderungen nötig.

### 6. InputSnapshot vs ControllerInput evaluieren

Es existieren zwei Input-Serialisierungsformate:
- `ControllerInput` (Prediction/) — `ControllerButtons : ushort`, umfangreicher
- `InputSnapshot` (Input/) — `InputButtons : byte`, kompakter

**Entscheidung:** Für Network-Sync wird `ControllerInput` verwendet (bereits für CSP designed). `InputSnapshot` bleibt für lokale Zwecke bestehen.

---

## Verifikation

- [ ] `INetworkRole` Interface in Core kompiliert
- [ ] `OfflineNetworkRole` als Default funktioniert
- [ ] `INetworkTickProvider` Interface in Core kompiliert
- [ ] `PlayerController.NetworkRole` Property vorhanden
- [ ] Im Offline-Modus: `NetworkRole.IsOwner == true`, `NetworkRole.IsNetworkActive == false`
- [ ] Core hat weiterhin **keine** FishNet-Referenz in der asmdef

---

## Erwartete Dateien

```
Packages/Wiesenwischer.GameKit.CharacterController.Core/Runtime/Core/Network/
├── INetworkRole.cs
├── OfflineNetworkRole.cs
└── INetworkTickProvider.cs
```

Geänderte Dateien:
- `PlayerController.cs` — NetworkRole Property + InitializeComponents()

---

→ Nächster Schritt: [6.3 NetworkManager & Connection Setup](6.3-network-manager.md)
