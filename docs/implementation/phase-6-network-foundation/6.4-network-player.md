# 6.4 NetworkPlayer Component

**Commit:** `feat(phase-6): 6.4 NetworkPlayer Component`
**Branch:** `feat/network-player`

---

## Ziel

`NetworkPlayer` als FishNet `NetworkBehaviour` erstellen, der den bestehenden `PlayerController` umschließt. NetworkPlayer managt Authority, Spawning-Lifecycle und verbindet die Netzwerk-Schicht mit der lokalen Simulation.

---

## Anweisungen

### 1. NetworkPlayer Klasse

Neue Klasse in `Network.FishNet/Runtime/Core/NetworkPlayer.cs`:

```csharp
using FishNet.Object;
using UnityEngine;
using Wiesenwischer.GameKit.CharacterController.Core;

namespace Wiesenwischer.GameKit.Network
{
    /// <summary>
    /// Root NetworkBehaviour für einen Spieler.
    /// Wraps PlayerController und stellt Network-Authority-Kontext bereit.
    /// </summary>
    [RequireComponent(typeof(PlayerController))]
    public class NetworkPlayer : NetworkBehaviour, INetworkRole
    {
        private PlayerController _playerController;

        // INetworkRole Implementation
        public new bool IsOwner => base.IsOwner;
        public bool IsServer => base.IsServerStarted;
        public bool IsClient => base.IsClientStarted;
        public bool IsNetworkActive => true;

        public override void OnStartNetwork()
        {
            base.OnStartNetwork();
            _playerController = GetComponent<PlayerController>();
        }

        public override void OnStartClient()
        {
            base.OnStartClient();

            if (IsOwner)
            {
                // Lokaler Spieler: Input aktivieren, Kamera zuweisen
                EnableLocalPlayer();
            }
            else
            {
                // Remote Spieler: Input deaktivieren
                DisableRemotePlayerInput();
            }
        }

        public override void OnStopClient()
        {
            base.OnStopClient();
            // Cleanup wenn Spieler das Spiel verlässt
        }

        private void EnableLocalPlayer()
        {
            // Input Provider aktivieren (nur Owner darf Input lesen)
            var inputProvider = GetComponent<IMovementInputProvider>();
            if (inputProvider != null)
            {
                // Input ist aktiv — PlayerController liest bereits davon
                Debug.Log("[NetworkPlayer] Lokaler Spieler initialisiert.");
            }

            // Kamera auf diesen Spieler setzen
            // (Camera-System folgt dem lokalen Player — wird vom Camera-Package gehandhabt)
        }

        private void DisableRemotePlayerInput()
        {
            // Remote Spieler brauchen keinen Input Provider
            // Die Bewegung kommt vom Server via State Sync
            var inputProvider = GetComponent<IMovementInputProvider>();
            if (inputProvider is MonoBehaviour inputMono)
            {
                inputMono.enabled = false;
            }

            Debug.Log("[NetworkPlayer] Remote Spieler — Input deaktiviert.");
        }
    }
}
```

### 2. FishNetNetworkRole

`NetworkPlayer` implementiert `INetworkRole` direkt (siehe oben). Da `NetworkPlayer : NetworkBehaviour` ist, hat es Zugriff auf `IsOwner`, `IsServerStarted`, etc.

`PlayerController` findet `INetworkRole` automatisch via `GetComponent<INetworkRole>()` (Schritt 6.2). Im Offline-Modus wird stattdessen `OfflineNetworkRole.Instance` verwendet.

### 3. Player Prefab anpassen

Das bestehende Player Prefab muss erweitert werden:

1. `NetworkObject` Komponente hinzufügen (FishNet — Root des Netzwerk-Objekts)
2. `NetworkPlayer` Komponente hinzufügen
3. `NetworkObject` muss OBERHALB von `PlayerController` in der Komponentenliste stehen

**Prefab-Hierarchie:**
```
Player (Root)
├── NetworkObject           (FishNet)
├── NetworkPlayer           (GameKit)
├── PlayerController        (GameKit)
├── CharacterMotor          (GameKit)
├── ...
└── Model (Child)
    └── Animator
```

### 4. Network Prefab als Spawnable registrieren

In der NetworkManager-Konfiguration:
- Player Prefab als "Default Player Prefab" oder in "Spawnable Prefabs" registrieren
- FishNet NetworkManager → Spawnable Prefabs → Player Prefab hinzufügen

### 5. Authority-basierte Update-Logik

`PlayerController.Update()` muss Authority-aware werden. Anpassung in `PlayerController.cs`:

```csharp
// In PlayerController.Update():
private void Update()
{
    // Nur der Owner simuliert Input + Prediction
    if (!NetworkRole.IsOwner) return;

    UpdateInput();
    _movementStateMachine?.Update();
    AbilitySystem?.Tick(Time.deltaTime);
    ConsumeMovementEvents();
    _tickSystem?.Update(Time.deltaTime);
}
```

**Wichtig:** Im Offline-Modus ist `NetworkRole` = `OfflineNetworkRole` → `IsOwner == true` → alles läuft wie bisher.

---

## Verifikation

- [ ] Player Prefab hat `NetworkObject` + `NetworkPlayer` Komponenten
- [ ] Host starten → lokaler Player spawnt, bewegt sich normal
- [ ] Client verbinden → zweiter Player spawnt
- [ ] Lokaler Player: Input aktiv, Bewegung funktioniert
- [ ] Remote Player: Input deaktiviert, steht still (State Sync kommt in 6.6)
- [ ] Offline-Modus (ohne NetworkManager): Alles funktioniert wie bisher

---

## Erwartete Dateien

```
Packages/Wiesenwischer.GameKit.Network.FishNet/Runtime/Core/
└── NetworkPlayer.cs
```

Geänderte Dateien:
- `PlayerController.cs` — Authority-Check in Update()
- Player Prefab — NetworkObject + NetworkPlayer hinzugefügt

---

## Hinweise

- `NetworkBehaviour.IsOwner` in FishNet gibt `true` zurück, wenn der Client die Authority über das Objekt hat
- `IsServerStarted` und `IsClientStarted` sind die FishNet-Properties für Server/Client-Erkennung
- Im Host-Modus ist der Host sowohl Server als auch Client und Owner seines eigenen Players

---

→ Nächster Schritt: [6.5 Input Sync](6.5-input-sync.md)
