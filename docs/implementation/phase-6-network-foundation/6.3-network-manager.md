# 6.3 NetworkManager & Connection Setup

**Commit:** `feat(phase-6): 6.3 NetworkManager & Connection Setup`
**Branch:** `feat/network-manager`

---

## Ziel

FishNet NetworkManager konfigurieren und einen GameKit-spezifischen Wrapper erstellen, der Server/Client/Host-Verbindung und Player-Spawning orchestriert.

---

## Anweisungen

### 1. NetworkManager Prefab

Erstelle ein Prefab `Assets/Prefabs/Network/NetworkManager.prefab` mit folgenden FishNet-Komponenten:

- **NetworkManager** (FishNet) — Kern-Komponente
- **Tugboat** (Transport) — UDP Transport für lokale Entwicklung
- **PlayerSpawner** (FishNet, optional) — oder eigene Spawn-Logik

**Konfiguration:**
- Server Tick Rate: 60 (passend zum TickSystem)
- Transport Port: 7770 (Standard)

### 2. GameNetworkManager

Neue Klasse in `Network.FishNet/Runtime/Core/GameNetworkManager.cs`:

```csharp
using FishNet;
using FishNet.Managing;
using FishNet.Object;
using FishNet.Transporting;
using UnityEngine;

namespace Wiesenwischer.GameKit.Network
{
    /// <summary>
    /// GameKit-Wrapper für FishNet NetworkManager.
    /// Handhabt Server/Client/Host Lifecycle und Player Spawning.
    /// </summary>
    public class GameNetworkManager : MonoBehaviour
    {
        [Header("Player")]
        [SerializeField] private NetworkObject _playerPrefab;

        [Header("Settings")]
        [SerializeField] private ushort _port = 7770;
        [SerializeField] private string _address = "localhost";

        private NetworkManager _networkManager;

        public bool IsServer => _networkManager != null && _networkManager.IsServerStarted;
        public bool IsClient => _networkManager != null && _networkManager.ClientManager.Started;

        private void Awake()
        {
            _networkManager = GetComponent<NetworkManager>();
            if (_networkManager == null)
            {
                Debug.LogError("[GameNetworkManager] NetworkManager nicht gefunden!");
                return;
            }

            // Events registrieren
            _networkManager.ServerManager.OnServerConnectionState += OnServerConnectionState;
            _networkManager.ClientManager.OnClientConnectionState += OnClientConnectionState;
            _networkManager.SceneManager.OnClientLoadedStartScenes += OnClientLoadedScenes;
        }

        private void OnDestroy()
        {
            if (_networkManager != null)
            {
                _networkManager.ServerManager.OnServerConnectionState -= OnServerConnectionState;
                _networkManager.ClientManager.OnClientConnectionState -= OnClientConnectionState;
                _networkManager.SceneManager.OnClientLoadedStartScenes -= OnClientLoadedScenes;
            }
        }

        /// <summary>Startet als Host (Server + Client).</summary>
        public void StartHost()
        {
            _networkManager.ServerManager.StartConnection(_port);
            _networkManager.ClientManager.StartConnection(_address, _port);
        }

        /// <summary>Startet nur den Server.</summary>
        public void StartServer()
        {
            _networkManager.ServerManager.StartConnection(_port);
        }

        /// <summary>Verbindet als Client zu einem Server.</summary>
        public void StartClient(string address = null, ushort port = 0)
        {
            _networkManager.ClientManager.StartConnection(
                address ?? _address,
                port > 0 ? port : _port);
        }

        /// <summary>Stoppt Server und/oder Client.</summary>
        public void Stop()
        {
            if (_networkManager.IsServerStarted)
                _networkManager.ServerManager.StopConnection(true);
            if (_networkManager.ClientManager.Started)
                _networkManager.ClientManager.StopConnection();
        }

        private void OnServerConnectionState(ServerConnectionStateArgs args)
        {
            Debug.Log($"[GameNetworkManager] Server: {args.ConnectionState}");
        }

        private void OnClientConnectionState(ClientConnectionStateArgs args)
        {
            Debug.Log($"[GameNetworkManager] Client: {args.ConnectionState}");
        }

        private void OnClientLoadedScenes(
            FishNet.Connection.NetworkConnection conn, bool asServer)
        {
            if (!asServer) return;
            if (_playerPrefab == null) return;

            // Player für die neue Verbindung spawnen
            var player = Instantiate(_playerPrefab);
            _networkManager.ServerManager.Spawn(player, conn);
            Debug.Log($"[GameNetworkManager] Player gespawnt für Connection {conn.ClientId}");
        }
    }
}
```

### 3. Network Test-Szene

Erstelle eine einfache Test-Szene `Assets/Scenes/NetworkTestScene.unity`:

- NetworkManager Prefab in die Szene
- Einfaches Terrain/Plane als Boden
- Einfaches UI mit Host/Client/Stop Buttons (optional, kann auch über Inspector getriggert werden)
- Kein Player in der Szene (wird via Spawning erstellt)

### 4. Einfaches Network UI (optional)

Erstelle `Network.FishNet/Runtime/UI/NetworkDebugUI.cs`:

```csharp
namespace Wiesenwischer.GameKit.Network
{
    /// <summary>
    /// Minimales Debug-UI zum Starten von Host/Client/Server.
    /// Nur für Entwicklung — wird später durch richtiges UI ersetzt.
    /// </summary>
    public class NetworkDebugUI : MonoBehaviour
    {
        private GameNetworkManager _manager;

        private void Awake()
        {
            _manager = FindObjectOfType<GameNetworkManager>();
        }

        private void OnGUI()
        {
            GUILayout.BeginArea(new Rect(10, 10, 200, 200));

            if (!_manager.IsServer && !_manager.IsClient)
            {
                if (GUILayout.Button("Host"))
                    _manager.StartHost();
                if (GUILayout.Button("Client"))
                    _manager.StartClient();
                if (GUILayout.Button("Server"))
                    _manager.StartServer();
            }
            else
            {
                GUILayout.Label($"Server: {_manager.IsServer}");
                GUILayout.Label($"Client: {_manager.IsClient}");
                if (GUILayout.Button("Stop"))
                    _manager.Stop();
            }

            GUILayout.EndArea();
        }
    }
}
```

---

## Verifikation

- [ ] NetworkManager Prefab in Szene platziert
- [ ] Host starten: Server + Client laufen
- [ ] Zweite Unity-Instanz kann als Client verbinden (ParrelSync oder Build)
- [ ] Player Prefab wird bei Connection automatisch gespawnt
- [ ] Kein Fehler in der Konsole

---

## Erwartete Dateien

```
Packages/Wiesenwischer.GameKit.Network.FishNet/Runtime/Core/
├── GameNetworkManager.cs
└── (weitere in späteren Schritten)

Packages/Wiesenwischer.GameKit.Network.FishNet/Runtime/UI/
└── NetworkDebugUI.cs

Assets/Prefabs/Network/
└── NetworkManager.prefab

Assets/Scenes/
└── NetworkTestScene.unity
```

---

### 5. Multiplayer-Test mit ParrelSync

ParrelSync wurde in Schritt 6.1 installiert. So testest du die Netzwerk-Szene:

1. **Editor 1 (Original):**
   - `NetworkTestScene` öffnen
   - Play drücken
   - "Host" Button klicken

2. **Editor 2 (ParrelSync-Klon):**
   - ParrelSync → Clones Manager → "Open in New Editor"
   - Gleiche `NetworkTestScene` öffnen
   - Play drücken
   - "Client" Button klicken

3. **Erwartetes Ergebnis:**
   - Konsole Editor 1: `Server: Started` + `Client: Started` + `Player gespawnt für Connection 0`
   - Konsole Editor 2: `Client: Started`
   - Bei Connection des zweiten Editors: `Player gespawnt für Connection 1`

**Tipp:** ParrelSync-Klon merkt sich die zuletzt geöffnete Szene. Du musst die NetworkTestScene nur beim ersten Mal manuell öffnen.

---

## Hinweise

- FishNet Server Tick Rate sollte mit `TickSystem.TickRate` übereinstimmen (60 Hz)
- Für diese Phase reicht Tugboat (UDP). Für Produktion: WebSocket oder Steam Networking

---

→ Nächster Schritt: [6.4 NetworkPlayer Component](6.4-network-player.md)
