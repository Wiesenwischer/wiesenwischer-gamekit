# 7.3 Remote Player Animation Setup

**Commit:** `feat(phase-7): 7.3 Remote Player Animation Setup`
**Branch:** `feat/remote-animation-setup`

---

## Ziel

Sicherstellen, dass Remote-Spieler einen funktionierenden Animator haben, der Animation-States und Parameter empfangen kann. Die `AnimatorParameterBridge` muss im "Empfangsmodus" laufen (keine eigene Berechnung, nur Netzwerk-Daten anwenden).

---

## Anweisungen

### 1. Remote-Mode in AnimatorParameterBridge

`AnimatorParameterBridge` muss wissen, ob es ein lokaler oder Remote-Spieler ist:

```csharp
// In AnimatorParameterBridge:

/// <summary>
/// Im Remote-Modus berechnet die Bridge keine eigenen Parameter-Werte.
/// Stattdessen werden Werte extern gesetzt (via Network Sync).
/// </summary>
public bool IsRemoteMode { get; set; }

private void LateUpdate()
{
    if (!_isValid) return;

    if (IsRemoteMode)
    {
        // Remote: Nur die extern gesetzten Werte an den Animator weiterleiten
        // Speed und VerticalVelocity wurden bereits via SetSpeed/SetVerticalVelocity gesetzt
        ApplyParametersToAnimator();
        return;
    }

    // Lokal: Eigene Berechnung (bestehende Logik)
    UpdateSpeed();
    UpdateVerticalVelocity();
    ApplyParametersToAnimator();
}

private void ApplyParametersToAnimator()
{
    _animator.SetFloat(AnimationParameters.SpeedHash,
        _currentSpeed, _speedDampTime, Time.deltaTime);
    _animator.SetFloat(AnimationParameters.VerticalVelocityHash,
        _currentVerticalVelocity);
}
```

### 2. NetworkPlayer Remote-Setup erweitern

In `NetworkPlayer.DisableRemotePlayerInput()` die Animation-Bridge auf Remote-Mode setzen:

```csharp
// In NetworkPlayer:
private void DisableRemotePlayerInput()
{
    // ... bestehende Logik (Input + Motor deaktivieren) ...

    // Animation Bridge in Remote-Modus setzen
    var animBridge = GetComponentInChildren<AnimatorParameterBridge>();
    if (animBridge != null)
    {
        animBridge.IsRemoteMode = true;
    }

    // PlayerController Update bereits deaktiviert (IsOwner == false)
    // StateMachine läuft nicht → keine lokalen PlayState() Aufrufe
}
```

### 3. Animator auf Remote-Spieler sicherstellen

Remote-Spieler brauchen:
- **Animator** Komponente aktiv (für Animation-Playback)
- **AnimatorParameterBridge** aktiv (im Remote-Mode)
- **AnimatorController** zugewiesen (gleicher wie lokaler Spieler)
- **CharacterMotor** deaktiviert (Position kommt via Interpolation)
- **PlayerController** Update deaktiviert (keine lokale Simulation)

### 4. AnimationTransitionConfig auf Remote-Spieler

Remote-Spieler verwenden die gleiche `AnimationTransitionConfig` wie lokale Spieler. Die CrossFade-Dauern sind identisch, damit Animationen synchron aussehen.

```csharp
// Remote PlayState() funktioniert identisch:
// AnimatorParameterBridge.PlayState(CharacterAnimationState.Jump)
//   → Animator.CrossFade("Jump", config.jumpTransition)
// Gleiche Transition-Zeiten wie lokal
```

### 5. Initial State Sync

Wenn ein neuer Client sich verbindet, muss er den aktuellen Animation-State des Remote-Spielers kennen:

```csharp
// In NetworkAnimationSync (ergänzen):

public override void OnStartClient()
{
    base.OnStartClient();

    if (!IsOwner)
    {
        // Aktuellen State vom Server anfordern
        // FishNet BufferLast=true auf ObserverRpc sorgt dafür,
        // dass der letzte State automatisch an neue Clients gesendet wird
    }
}
```

Alternativ: `SyncVar` für den aktuellen State verwenden:

```csharp
// In NetworkAnimationSync:
[SyncVar(OnChange = nameof(OnAnimStateChanged))]
private byte _currentAnimState;

private void OnAnimStateChanged(byte prev, byte next, bool asServer)
{
    if (IsOwner) return;
    _animController?.PlayState((CharacterAnimationState)next);
}
```

---

## Verifikation

- [ ] Neuer Client verbindet → sieht Remote-Spieler sofort in korrekter Animation
- [ ] Remote AnimatorParameterBridge berechnet keine eigenen Werte
- [ ] Remote Animator spielt korrekte Blend Trees (Speed-abhängig)
- [ ] Remote-Spieler hat Animator + AnimatorParameterBridge aktiv
- [ ] Lokaler Spieler: Keine Verhaltensänderung (IsRemoteMode == false)

---

## Erwartete Dateien

Geänderte Dateien:
- `AnimatorParameterBridge.cs` — `IsRemoteMode` Property + Split der Update-Logik
- `NetworkPlayer.cs` — Remote Animation Setup
- `NetworkAnimationSync.cs` — Initial State Sync (SyncVar oder BufferLast)

---

→ Nächster Schritt: [7.4 Ability Animation Sync](7.4-ability-animation-sync.md)
