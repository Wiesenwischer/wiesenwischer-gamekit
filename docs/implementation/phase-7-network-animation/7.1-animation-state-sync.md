# 7.1 Animation State Sync

**Commit:** `feat(phase-7): 7.1 Animation State Sync`
**Branch:** `feat/network-animation-state`

---

## Ziel

Wenn der lokale Spieler einen Animations-State wechselt (z.B. Locomotion → Jump), wird dieser Wechsel über das Netzwerk an alle Remote-Clients gesendet. Remote-Clients rufen denselben `PlayState()` auf ihrem lokalen Animator auf.

---

## Anweisungen

### 1. NetworkAnimationSync Komponente

Neue Klasse in `Network.FishNet/Runtime/Core/NetworkAnimationSync.cs`:

```csharp
using FishNet.Object;
using UnityEngine;
using Wiesenwischer.GameKit.CharacterController.Core.Animation;

namespace Wiesenwischer.GameKit.Network
{
    /// <summary>
    /// Synchronisiert Animation-State-Wechsel über das Netzwerk.
    /// Erfasst PlayState-Aufrufe auf dem Owner und broadcastet sie
    /// an alle Observer-Clients.
    /// </summary>
    [RequireComponent(typeof(NetworkPlayer))]
    public class NetworkAnimationSync : NetworkBehaviour
    {
        private IAnimationController _animController;
        private CharacterAnimationState _lastSyncedState;
        private bool _initialized;

        public override void OnStartNetwork()
        {
            base.OnStartNetwork();
            _animController = GetComponentInChildren<IAnimationController>();
        }

        /// <summary>
        /// Wird vom lokalen Spieler aufgerufen wenn PlayState() getriggert wird.
        /// Broadcastet den State an alle Clients.
        /// </summary>
        public void OnLocalStateChanged(CharacterAnimationState state)
        {
            if (!IsOwner) return;
            if (state == _lastSyncedState && _initialized) return;

            _lastSyncedState = state;
            _initialized = true;

            // An Server senden, der broadcastet weiter
            ServerRpcAnimationState((byte)state);
        }

        [ServerRpc]
        private void ServerRpcAnimationState(byte stateValue)
        {
            // Server broadcastet an alle Observer (inkl. sich selbst wenn Host)
            ObserverRpcAnimationState(stateValue);
        }

        [ObserverRpc(ExcludeOwner = true)]
        private void ObserverRpcAnimationState(byte stateValue)
        {
            var state = (CharacterAnimationState)stateValue;
            _animController?.PlayState(state);
        }
    }
}
```

### 2. AnimatorParameterBridge erweitern

`AnimatorParameterBridge` muss `NetworkAnimationSync` benachrichtigen wenn `PlayState()` aufgerufen wird:

```csharp
// In AnimatorParameterBridge.PlayState():
public void PlayState(CharacterAnimationState state)
{
    // ... bestehende PlayState-Logik ...

    // Network Sync (falls vorhanden)
    _networkSync?.OnLocalStateChanged(state);
}
```

Die Referenz wird per `GetComponent<NetworkAnimationSync>()` im `Awake()` oder `Start()` geholt. Falls keine `NetworkAnimationSync`-Komponente vorhanden ist (Offline-Modus), passiert nichts.

**Wichtig:** `AnimatorParameterBridge` liegt im `CharacterController.Animation`-Package, das keine FishNet-Abhängigkeit hat. Daher muss ein **Interface** als Brücke dienen:

### 3. IAnimationNetworkSync Interface (in Core)

Neues Interface in `CharacterController.Core/Runtime/Core/Animation/IAnimationNetworkSync.cs`:

```csharp
namespace Wiesenwischer.GameKit.CharacterController.Core.Animation
{
    /// <summary>
    /// Interface für Netzwerk-Synchronisation von Animation-State-Wechseln.
    /// Implementiert vom Network-Package (NetworkAnimationSync).
    /// AnimatorParameterBridge ruft dies auf, ohne FishNet zu kennen.
    /// </summary>
    public interface IAnimationNetworkSync
    {
        void OnLocalStateChanged(CharacterAnimationState state);
    }
}
```

### 4. AnimatorParameterBridge Integration

```csharp
// In AnimatorParameterBridge:
private IAnimationNetworkSync _networkSync;

private void Awake()
{
    // ... bestehende Initialisierung ...
    _networkSync = GetComponentInParent<IAnimationNetworkSync>();
}

public void PlayState(CharacterAnimationState state)
{
    // ... bestehende CrossFade-Logik ...

    // Network: State-Wechsel melden
    _networkSync?.OnLocalStateChanged(state);
}
```

### 5. NetworkAnimationSync implementiert IAnimationNetworkSync

```csharp
public class NetworkAnimationSync : NetworkBehaviour, IAnimationNetworkSync
{
    // ... (siehe oben)
}
```

---

## Verifikation

- [ ] Lokaler Spieler wechselt Animation State → Remote sieht sofort den gleichen State
- [ ] Jump, Fall, Land, Roll, Crouch, Slide werden korrekt auf Remote dargestellt
- [ ] Redundante States werden gefiltert (kein Doppel-Send bei Locomotion→Locomotion)
- [ ] Offline-Modus: Keine Regression (`_networkSync` ist null, kein Effekt)
- [ ] Bandbreite: State-Wechsel als `byte` gesendet (~1 Byte pro Wechsel)

---

## Erwartete Dateien

```
Packages/Wiesenwischer.GameKit.CharacterController.Core/Runtime/Core/Animation/
└── IAnimationNetworkSync.cs

Packages/Wiesenwischer.GameKit.Network.FishNet/Runtime/Core/
└── NetworkAnimationSync.cs
```

Geänderte Dateien:
- `AnimatorParameterBridge.cs` — `IAnimationNetworkSync`-Referenz + Aufruf in PlayState()

---

→ Nächster Schritt: [7.2 Animator Parameter Sync](7.2-parameter-sync.md)
