# 24.3 Delta-basierte Dead Zone pro Fuß

> **Commit-Message:** `fix(phase-24): 24.3 Delta Dead Zone pro Fuß`
> **Branch:** `fix/footik-dead-zone`
> **Spec-Referenz:** [FootIK Verbesserungen — Fix 3](../../specs/FootIK_Verbesserungen_Spezifikation.md#fix-3-delta-basierte-dead-zone-pro-fuß)

---

## Ziel

Wenn der Unterschied zwischen animierter Fußposition und IK-Target unter einem Schwellwert liegt, den IK-Weight für diesen einzelnen Fuß reduzieren. Verhindert Mikro-Korrekturen auf flachem Boden, wo die Animation die Füße bereits korrekt platziert hat.

---

## Änderungen

### 1. Neuer Parameter `_footDeadZone`

Im `[Header("Terrain Adaptation")]` Bereich (nach `_terrainVarianceThreshold` aus Schritt 24.2):

```csharp
[Tooltip("Minimaler Fuß-Versatz (m) ab dem IK eingreift.")]
[SerializeField] private float _footDeadZone = 0.02f;
```

### 2. Per-Fuß Weight in ProcessIK

In `ProcessIK()`, für den **linken Fuß** (nach der effectiveWeight-Berechnung):

```csharp
// Left Foot
if (_leftFootHit)
{
    float leftDelta = (_leftFootTarget - animator.GetIKPosition(AvatarIKGoal.LeftFoot)).magnitude;
    float leftFootWeight = effectiveWeight * Mathf.InverseLerp(0f, _footDeadZone, leftDelta);

    animator.SetIKPositionWeight(AvatarIKGoal.LeftFoot, leftFootWeight);
    animator.SetIKRotationWeight(AvatarIKGoal.LeftFoot, leftFootWeight);
    animator.SetIKPosition(AvatarIKGoal.LeftFoot, ClampFootTarget(_leftFootTarget, animator, AvatarIKGoal.LeftFoot));
    animator.SetIKRotation(AvatarIKGoal.LeftFoot, _leftFootRotation);
}
```

Analog für den **rechten Fuß**:

```csharp
// Right Foot
if (_rightFootHit)
{
    float rightDelta = (_rightFootTarget - animator.GetIKPosition(AvatarIKGoal.RightFoot)).magnitude;
    float rightFootWeight = effectiveWeight * Mathf.InverseLerp(0f, _footDeadZone, rightDelta);

    animator.SetIKPositionWeight(AvatarIKGoal.RightFoot, rightFootWeight);
    animator.SetIKRotationWeight(AvatarIKGoal.RightFoot, rightFootWeight);
    animator.SetIKPosition(AvatarIKGoal.RightFoot, ClampFootTarget(_rightFootTarget, animator, AvatarIKGoal.RightFoot));
    animator.SetIKRotation(AvatarIKGoal.RightFoot, _rightFootRotation);
}
```

**Erklärung:**
- `animator.GetIKPosition()` gibt die aktuelle (animierte) Fußposition zurück
- `leftDelta` = Abstand zwischen IK-Target und animierter Position
- `InverseLerp(0, deadZone, delta)`: Bei `delta = 0` → Weight = 0, bei `delta >= deadZone` → Weight = 1
- Jeder Fuß bekommt seinen eigenen Weight — ein Fuß kann voll IK-gesteuert sein (auf Treppenstufe), während der andere bei der Animation bleibt (auf flachem Boden)

---

## Erwartetes Verhalten

| Delta | InverseLerp | Fuß-Weight (bei effectiveWeight=1) |
|-------|-------------|-------------------------------------|
| 0.0 cm | 0.0 | 0.0 — Animation |
| 0.5 cm | 0.25 | 0.25 — Leichtes IK |
| 1.0 cm | 0.5 | 0.5 — Halb IK |
| 2.0 cm | 1.0 | 1.0 — Volles IK |
| 5.0 cm | 1.0 | 1.0 — Volles IK |

---

## Zusammenspiel der drei Fixes

Nach allen drei Fixes berechnet sich der finale IK-Weight pro Fuß so:

```
footWeight = _weight                    (globaler IK-Weight)
           × _locomotionBlendWeight     (0 bei Bewegung, 1 bei Idle)
           × _terrainWeight             (0 auf flachem Boden, 1 auf unebenem Terrain)
           × InverseLerp(0, deadZone, footDelta)  (0 bei minimalem Delta, 1 bei großem Delta)
```

Auf **flachem Boden im Idle** wird der Weight durch mindestens zwei Faktoren (~0):
- `_terrainWeight ≈ 0` (keine Höhendifferenz)
- `footDelta ≈ 0.04` (nur durch footOffset) × DeadZone → reduziert

Auf **Treppen im Idle** bleibt der Weight bei ~1:
- `_terrainWeight ≈ 1` (Höhendifferenz > threshold)
- `footDelta >> deadZone` → Faktor 1

---

## Verifikation

- [ ] Compiler-Fehler prüfen
- [ ] `_footDeadZone` erscheint im Inspector unter "Terrain Adaptation"
- [ ] Default-Wert ist 0.02 im Inspector
- [ ] Flacher Boden: Füße folgen Animation (kein IK-Eingriff)
- [ ] Treppe: Füße passen sich weiterhin an Stufen an

---

## Erwartete Dateien

| Datei | Änderung |
|-------|----------|
| `FootIK.cs` | Neuer Parameter `_footDeadZone`, Per-Fuß Weight-Berechnung in ProcessIK |

---

→ Nächster Schritt: [24.4 Unit Tests](24.4-unit-tests.md)
