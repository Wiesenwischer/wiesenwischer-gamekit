# 26.3 Camera Anchor

> **Commit:** `feat(phase-26): 26.3 Camera Anchor`

---

## Ziel

Stabilisierte Follow-Position für die Kamera. Der Anchor folgt dem **Movement Root** (PlayerController Transform), nicht Bone-Positionen, und filtert Animation Noise / IK-Bewegungen / Root Motion Jitter heraus.

---

## Warum nicht direkt dem Character folgen?

Die alte ThirdPersonCamera folgt `_target` direkt mit SmoothDamp. Das funktioniert grundsätzlich, aber:

- **IK-Bewegungen** (FootIK, LookAt) verschieben den Mesh, nicht den Controller Transform — kein Problem
- **Root Motion Jitter** bei bestimmten Animationen kann die Kamera wackeln lassen
- **Step-Up-Events** (Treppen) erzeugen diskrete Y-Sprünge

Der CameraAnchor glättet die Follow-Position mit **separaten XZ/Y-Dampings**, sodass:
- Horizontale Bewegung (XZ) nahezu direkt folgt (wenig Lag)
- Vertikale Bewegung (Y) stärker geglättet wird (gegen Step-Up-Jitter)

---

## Implementierung

**`Runtime/Anchor/CameraAnchor.cs`**

```csharp
namespace Wiesenwischer.GameKit.Camera
{
    /// <summary>
    /// Stabilisiert die Follow-Position gegen Animation Noise und Root Motion Jitter.
    /// Folgt dem Movement Root Transform mit konfigurierbaren SmoothDamp-Werten.
    /// </summary>
    public class CameraAnchor : MonoBehaviour
    {
        [Header("Follow Target")]
        [SerializeField] private Transform _followTarget;

        [Header("Smoothing")]
        [Tooltip("SmoothDamp-Zeit für horizontale Bewegung (XZ). Niedrig = wenig Lag.")]
        [SerializeField] private float _horizontalDamping = 0.02f;

        [Tooltip("SmoothDamp-Zeit für vertikale Bewegung (Y). Höher = stärkere Glättung.")]
        [SerializeField] private float _verticalDamping = 0.08f;

        [Header("Target Offset")]
        [Tooltip("Offset relativ zum Follow-Target (z.B. Höhe über Character-Root).")]
        [SerializeField] private Vector3 _targetOffset = new Vector3(0f, 1.5f, 0f);

        // SmoothDamp Velocity tracking
        private Vector3 _velocityXZ;
        private float _velocityY;

        /// <summary>Aktuelle stabilisierte Position.</summary>
        public Vector3 AnchorPosition { get; private set; }

        public Transform FollowTarget
        {
            get => _followTarget;
            set => _followTarget = value;
        }

        public Vector3 TargetOffset
        {
            get => _targetOffset;
            set => _targetOffset = value;
        }

        /// <summary>
        /// Aktualisiert die Anchor-Position. Wird vom CameraBrain aufgerufen.
        /// </summary>
        public void UpdateAnchor(float deltaTime)
        {
            if (_followTarget == null) return;

            Vector3 targetPos = _followTarget.position + _targetOffset;
            Vector3 current = AnchorPosition;

            // XZ separat (wenig Lag)
            float smoothedX = Mathf.SmoothDamp(current.x, targetPos.x, ref _velocityXZ.x, _horizontalDamping, Mathf.Infinity, deltaTime);
            float smoothedZ = Mathf.SmoothDamp(current.z, targetPos.z, ref _velocityXZ.z, _horizontalDamping, Mathf.Infinity, deltaTime);

            // Y separat (stärkere Glättung)
            float smoothedY = Mathf.SmoothDamp(current.y, targetPos.y, ref _velocityY, _verticalDamping, Mathf.Infinity, deltaTime);

            AnchorPosition = new Vector3(smoothedX, smoothedY, smoothedZ);
        }

        /// <summary>
        /// Teleportiert den Anchor sofort zur Zielposition (kein Smoothing).
        /// Nützlich nach Scene-Load oder Teleport.
        /// </summary>
        public void SnapToTarget()
        {
            if (_followTarget == null) return;
            AnchorPosition = _followTarget.position + _targetOffset;
            _velocityXZ = Vector3.zero;
            _velocityY = 0f;
        }
    }
}
```

---

## Konfiguration

| Parameter | Default | Erklärung |
|-----------|---------|-----------|
| `_horizontalDamping` | 0.02s | Fast direkte XZ-Folge (20ms Lag) |
| `_verticalDamping` | 0.08s | Stärkere Y-Glättung gegen Step-Ups |
| `_targetOffset` | (0, 1.5, 0) | Kamera-Pivot auf Brusthöhe |

---

## Vergleich mit alter Implementierung

| Aspekt | Alt (ThirdPersonCamera) | Neu (CameraAnchor) |
|--------|------------------------|---------------------|
| Follow-Methode | Single SmoothDamp | Separate XZ/Y Dampings |
| Offset | `_config.TargetOffset` | `_targetOffset` (konfigurierbar) |
| Teleport | `TeleportToTarget()` | `SnapToTarget()` |
| Stabilisierung | Nur Follow-Damping | Dedizierte Noise-Filterung |

---

## Akzeptanzkriterien

- [ ] AnchorPosition folgt dem FollowTarget geglättet
- [ ] XZ und Y werden mit unterschiedlichen Dampings geglättet
- [ ] SnapToTarget() setzt Position sofort (kein SmoothDamp-Lag)
- [ ] Kein visuelles Wackeln bei Treppen-Step-Ups
